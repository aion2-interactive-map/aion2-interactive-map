import{s as e}from"./rolldown-runtime-Cb2Vi1zU.js";import{a as t,n}from"./vendor-react-Pim_c09P.js";import{At as r,Bt as i,D as a,Gt as o,Ht as s,Jt as c,Kt as l,Mt as u,Nt as d,Pt as f,Vt as p,X as m,Xt as h,Z as g,Zt as _,_t as v,an as y,bt as b,ft as x,gt as S,in as C,it as w,jt as T,on as E,pt as D,qt as O,rn as k,st as A,tn as j,ut as M,vt as N,xt as P,yt as F,z as I,zt as L}from"./vendor-ui-C-FJ7-0S.js";import{l as R,o as z,p as B,s as V,t as H,x as U,y as W}from"./index-BrHMOM_c.js";import{t as G}from"./AdaptiveTooltip-zQu5_RVr.js";import{t as K}from"./Footer-DlDmVCG3.js";var q=e(t(),1),J=e(n(),1),Y=({isOpen:e,onOpenChange:t,matching:n,mapName:i,initialState:a,seasonId:c})=>{let{t:l,i18n:p}=U(`common`),{createArtifactState:m,updateArtifactState:h,artifactsByMap:v}=z(),b=(0,q.useMemo)(()=>(v[i]||[]).sort((e,t)=>e.order-t.order),[v,i]),[S,w]=(0,q.useState)(C(y())),[O,j]=(0,q.useState)(`48:00:00`),[N,P]=(0,q.useState)({}),[F,I]=(0,q.useState)(!1),[L,R]=(0,q.useState)(C(y())),B=e=>{let t=new Date(e).getTime(),n=Date.now(),r=t+1728e5-n;if(r<=0)return`48:00:00`;let i=Math.floor(r/(1e3*60*60)),a=Math.floor(r%(1e3*60*60)/(1e3*60)),o=Math.floor(r%(1e3*60)/1e3);return`${String(i).padStart(2,`0`)}:${String(a).padStart(2,`0`)}:${String(o).padStart(2,`0`)}`};(0,q.useEffect)(()=>{if(e)if(a)if(new Date(a.recordTime).getTime()+2880*60*1e3-Date.now()<=0||!a.id){w(C(y())),j(`48:00:00`),R(C(y())),I(!0);let e={};a.states?a.states.forEach(t=>{e[t.abyssArtifactId]=t.state}):b.forEach(t=>{e[t.id]=1}),P(e)}else{w(k(a.recordTime)),j(B(a.recordTime)),R(k(a.recordTime)),I(!1);let e={};a.states.forEach(t=>{e[t.abyssArtifactId]=t.state}),P(e)}else{w(C(y())),j(`48:00:00`),R(C(y())),I(!0);let e={};b.forEach(t=>{e[t.id]=1}),P(e)}},[e,a,b]);let V=(0,q.useMemo)(()=>!a||!a.id?!1:new Date(a.recordTime).getTime()+2880*60*1e3-Date.now()>0,[a]),H=(0,q.useMemo)(()=>{if(!F)return L;if(!S||!O)return null;try{let e=S.toDate(),[t,n,r]=O.split(`:`).map(Number),i=((t||0)*3600+(n||0)*60+(r||0))*1e3,a=e.getTime()+i-48*3600*1e3;return k(new Date(a).toISOString())}catch{return null}},[S,O,F,L]),W=(0,q.useMemo)(()=>{if(!F)return L?new Date(L.toDate()).toISOString():``;if(!S||!O)return``;try{let e=S.toDate(),[t,n,r]=O.split(`:`).map(Number),i=((t||0)*3600+(n||0)*60+(r||0))*1e3,a=e.getTime()+i-48*3600*1e3;return new Date(a).toISOString()}catch{return``}},[S,O,F,L]),K=async()=>{let e=Object.entries(N).map(([e,t])=>({abyssArtifactId:e,state:t})),r=!1;r=V&&a?await h(c,i,a.id,{states:e,recordTime:W}):await m(c,i,{serverMatchingId:n.id,states:e,recordTime:W}),r&&t(!1)},Y=(e,t)=>{P(n=>({...n,[e]:t}))},X=e=>(0,J.jsxs)(`div`,{className:`flex items-center justify-between gap-4`,children:[(0,J.jsx)(`span`,{className:`text-sm flex-1`,children:l(`markers/${e.marker.mapId}:${e.markerId}.name`,e.marker.name)}),(0,J.jsxs)(x,{size:`sm`,className:`w-[100px]`,selectedKeys:[String(N[e.id]||1)],onSelectionChange:t=>Y(e.id,Number(Array.from(t)[0])),disallowEmptySelection:!0,classNames:Z,popoverProps:{radius:`none`},listboxProps:Q,children:[(0,J.jsx)(D,{textValue:l(`leaderboard.artifactState.light`),children:l(`leaderboard.artifactState.light`)},`1`),(0,J.jsx)(D,{textValue:l(`leaderboard.artifactState.dark`),children:l(`leaderboard.artifactState.dark`)},`2`)]})]},e.id),Z={inputWrapper:`!bg-character-card hover:!bg-character-card focus:!bg-character-card !transition-none border-crafting-border border-1 shadow-none rounded-sm group-data-[hover=true]:!bg-character-card group-data-[focus=true]:!bg-character-card group-data-[focus-visible=true]:!bg-character-card min-h-[36px]`,popoverContent:`rounded-none p-0`,segment:`text-foreground`,trigger:`!bg-character-card hover:!bg-character-card focus:!bg-character-card !transition-none border-crafting-border border-1 shadow-none rounded-sm group-data-[hover=true]:!bg-character-card group-data-[focus=true]:!bg-character-card group-data-[focus-visible=true]:!bg-character-card min-h-[36px]`,innerWrapper:`py-0`},Q={itemClasses:{base:`rounded-none`}};return(0,J.jsx)(r,{isOpen:e,onOpenChange:t,size:`xl`,classNames:{base:`bg-character-equipment`},children:(0,J.jsx)(d,{children:e=>(0,J.jsxs)(J.Fragment,{children:[(0,J.jsxs)(T,{children:[l(V?`leaderboard.artifactState.update`:`leaderboard.artifactState.create`),` - ${n.server1.serverName} VS ${n.server2.serverName}`]}),(0,J.jsxs)(f,{className:`gap-4`,children:[(0,J.jsx)(`div`,{className:`flex items-center gap-2 mb-2`,children:(0,J.jsx)(o,{isSelected:F,onValueChange:I,size:`sm`,children:l(`leaderboard.artifactState.countdownMode`)})}),(0,J.jsx)(E,{locale:p.language,children:F?(0,J.jsxs)(J.Fragment,{children:[(0,J.jsxs)(`div`,{className:`relative group/picker`,children:[(0,J.jsx)(M,{label:l(`leaderboard.artifactState.uploadTime`),hideTimeZone:!0,showMonthAndYearPickers:!0,value:S,onChange:e=>{e&&w(e)},classNames:Z,granularity:`second`}),(0,J.jsx)(G,{content:l(`common:leaderboard.resetToNow`,`重置到当前时间`),children:(0,J.jsx)(_,{size:`sm`,variant:`flat`,isIconOnly:!0,className:`absolute right-10 bottom-2 z-20 h-6 w-6 min-w-0 bg-transparent`,onClick:()=>{w(C(y()))},children:(0,J.jsx)(A,{icon:g,className:`text-[12px]`})})})]}),(0,J.jsx)(s,{label:l(`leaderboard.artifactState.countdown`),placeholder:`hh:mm:ss`,value:O,onChange:e=>j(e.target.value),classNames:Z})]}):(0,J.jsx)(M,{label:l(`leaderboard.artifactState.recordTime`),hideTimeZone:!0,showMonthAndYearPickers:!0,value:L,onChange:e=>{e&&R(e)},classNames:Z,granularity:`second`})}),F&&(0,J.jsx)(E,{locale:p.language,children:(0,J.jsx)(M,{label:l(`leaderboard.artifactState.recordTime`),hideTimeZone:!0,showMonthAndYearPickers:!0,value:H,isDisabled:!0,classNames:Z,granularity:`second`})}),(0,J.jsxs)(`div`,{className:`flex flex-col gap-2 mt-2`,children:[(0,J.jsx)(`p`,{className:`font-bold`,children:l(`maps:${i}.description`)}),b.map(X)]})]}),(0,J.jsxs)(u,{children:[(0,J.jsx)(_,{variant:`light`,onPress:e,children:l(`leaderboard.artifactState.cancel`)}),(0,J.jsx)(_,{color:`primary`,onPress:K,children:l(`leaderboard.artifactState.save`)})]})]})})})},X=({children:e,title:t,onConfirm:n,confirmText:r,cancelText:a,color:o=`danger`})=>{let{t:s}=U(`common`),[c,l]=q.useState(!1);return(0,J.jsxs)(L,{isOpen:c,onOpenChange:e=>l(e),placement:`top`,children:[(0,J.jsx)(i,{children:e}),(0,J.jsx)(p,{className:`p-4`,children:(0,J.jsxs)(`div`,{className:`flex flex-col gap-4`,children:[(0,J.jsx)(`div`,{className:`text-sm font-medium`,children:t}),(0,J.jsxs)(`div`,{className:`flex justify-center gap-2`,children:[(0,J.jsx)(_,{size:`sm`,variant:`flat`,onClick:()=>l(!1),children:a||s(`ui.cancel`)}),(0,J.jsx)(_,{size:`sm`,color:o,onClick:()=>{n(),l(!1)},children:r||s(`ui.confirm`)})]})]})})]})};function Z(){let{matchingId:e}=H.useParams(),t=B(),n=[V.ABYSS_A,V.ABYSS_B],{t:r}=U([...n.map(e=>`markers/${e}`),`common`]),{isSuperUser:i}=R(),{seasons:o,serverMatchings:s,artifactsByMap:u,fetchServerMatching:d,fetchArtifactStates:f,region:p,deleteArtifactState:g}=z(),[y,x]=(0,q.useState)(!1),[C,T]=(0,q.useState)(null),[E,D]=(0,q.useState)(null),[k,M]=(0,q.useState)([]),L=(0,q.useMemo)(()=>s.find(t=>t.id===e),[s,e]),G=(0,q.useMemo)(()=>{if(L)return L.seasonId;let e=o.filter(e=>e.serverRegion.toLowerCase()===p.toLowerCase());if(e.length===0)return null;let t=Math.max(...e.map(e=>e.number));return e.find(e=>e.number===t)?.id||null},[p,o,L]);(0,q.useEffect)(()=>{G&&(L||d(G,e),f(G,void 0,e).then(e=>{M(e)}))},[G,e,L,d,f]);let Z=(0,q.useMemo)(()=>{let t={};return k.filter(t=>t.serverMatchingId===e).forEach(e=>{t[e.mapName]||(t[e.mapName]=[]),t[e.mapName].push(e)}),Object.keys(t).forEach(e=>{t[e].sort((e,t)=>new Date(t.recordTime).getTime()-new Date(e.recordTime).getTime())}),t},[k,e]),Q=(0,q.useMemo)(()=>{let e={};return Object.keys(u).forEach(t=>{e[t]=[...u[t]].sort((e,t)=>e.order-t.order)}),e},[u]),$=(e,t)=>{L&&(T(t),D(e),x(!0))},ee=(e,t)=>{L&&(T(e),D(t?{...t,id:``}:null),x(!0))},te=async t=>{G&&await g(G,t.mapName,t.id,e)&&M(await f(G,void 0,e))},ne=(e,t)=>{let n=new Date(e).getTime(),r=new Date(t).getTime(),i=Math.abs(n-r)-2880*60*1e3,a=i<0,o=Math.abs(i),s=Math.floor(o/(1e3*60*60)),c=Math.floor(o%(1e3*60*60)/(1e3*60)),l=Math.floor(o%(1e3*60)/1e3);return`${a?`-`:``}${String(s).padStart(2,`0`)}:${String(c).padStart(2,`0`)}:${String(l).padStart(2,`0`)}`},re=W(`UI/Resource/Texture/Icon/UT_Marker_AbyssArtifact_Neutral.webp`),ie=W(`UI/Resource/Texture/Icon/UT_Marker_AbyssArtifact_Light.webp`),ae=W(`UI/Resource/Texture/Icon/UT_Marker_AbyssArtifact_Dark.webp`);return!L&&!G?(0,J.jsx)(`div`,{className:`p-8 text-center`,children:r(`common:ui.loading`)}):(0,J.jsxs)(`div`,{className:`min-h-full flex flex-col`,children:[(0,J.jsxs)(`div`,{className:`flex-1 flex flex-col items-center p-4`,children:[(0,J.jsxs)(`div`,{className:`w-full max-w-[1400px] flex flex-col gap-6`,children:[(0,J.jsxs)(`div`,{className:`flex items-center gap-4`,children:[(0,J.jsx)(_,{isIconOnly:!0,variant:`flat`,className:`bg-character-card border-1 border-crafting-border`,onClick:()=>t({to:`/leaderboard`}),children:(0,J.jsx)(A,{icon:a})}),(0,J.jsx)(`h1`,{className:`text-2xl font-bold`,children:L?`${L.server1.serverName} VS ${L.server2.serverName}`:r(`common:leaderboard.artifactDetails`)})]}),n.map(e=>{let t=Z[e]||[],n=Q[e]||[];return(0,J.jsxs)(O,{className:`bg-character-equipment shadow-none border-1 border-crafting-border`,children:[(0,J.jsxs)(c,{className:`flex justify-between items-center px-6 py-4`,children:[(0,J.jsx)(`h2`,{className:`text-xl font-bold`,children:r(`maps:${e}.description`)}),i&&(0,J.jsx)(_,{size:`sm`,color:`default`,variant:`flat`,startContent:(0,J.jsx)(A,{icon:m}),onClick:()=>ee(e),children:r(`common:leaderboard.artifactState.create`)})]}),(0,J.jsx)(j,{}),(0,J.jsx)(h,{className:`p-0 overflow-x-auto`,children:(0,J.jsxs)(P,{"aria-label":`Artifact states for ${e}`,className:`min-w-full`,removeWrapper:!0,classNames:{th:`bg-character-card text-foreground border-b border-crafting-border first:rounded-none last:rounded-none`,td:`py-3 px-4 border-b border-crafting-border/50`},children:[(0,J.jsx)(F,{columns:[{id:`recordTime`,label:r(`common:leaderboard.artifactState.recordTime`),width:200},...n.map(t=>({id:t.id,label:r(`markers/${e}:${t.markerId}.name`,{defaultValue:t.marker.name}),isArtifact:!0})),{id:`options`,label:r(`common:leaderboard.options`),width:100}],children:e=>(0,J.jsx)(b,{width:e.width,align:`center`,children:e.isArtifact?(0,J.jsx)(`div`,{className:`flex flex-col items-center gap-1 min-w-[120px]`,children:(0,J.jsx)(`span`,{className:`text-[12px] whitespace-nowrap overflow-hidden text-ellipsis max-w-[120px]`,children:e.label})}):e.label},e.id)}),(0,J.jsx)(v,{emptyContent:r(`common:ui.noData`),items:t.flatMap((r,i)=>{let a=[];if(a.push({type:`data`,id:r.id,state:r,mapName:e,arts:n}),i<t.length-1){let e=t[i+1];a.push({type:`diff`,id:`diff-${r.id}-${e.id}`,state:r,nextState:e,arts:n})}return a}),children:e=>{if(e.type===`diff`){let t=ne(e.state.recordTime,e.nextState.recordTime);return(0,J.jsx)(N,{className:`bg-default-50/30`,children:(0,J.jsx)(S,{colSpan:n.length+2,children:(0,J.jsx)(`div`,{className:`flex justify-center items-center px-4 py-1`,children:(0,J.jsxs)(`span`,{className:`text-sm text-default-800 italic text-center`,children:[r(`common:leaderboard.timeDiffToNext`,`Time diff to next record`),`: `,t]})})})},e.id)}return(0,J.jsxs)(N,{children:[(0,J.jsx)(S,{children:(0,J.jsx)(`div`,{className:`flex flex-col`,children:(0,J.jsx)(`span`,{className:`font-medium`,children:new Date(e.state.recordTime).toLocaleString()})})},`recordTime`),e.arts.map(t=>{let n=e.state.states.find(e=>e.abyssArtifactId===t.id);return(0,J.jsx)(S,{children:(0,J.jsx)(`div`,{className:`flex justify-center`,children:(0,J.jsx)(`img`,{src:n?.state===1?ie:n?.state===2?ae:re,alt:`state`,className:`w-10 h-10`})})},t.id)}),(0,J.jsx)(S,{children:(0,J.jsx)(`div`,{className:`flex justify-center gap-2`,children:i&&(0,J.jsxs)(J.Fragment,{children:[(0,J.jsx)(l,{content:r(`common:ui.edit`),children:(0,J.jsx)(_,{isIconOnly:!0,size:`sm`,variant:`light`,onClick:()=>$(e.state,e.mapName),children:(0,J.jsx)(A,{icon:I,className:`text-primary`})})}),(0,J.jsx)(X,{title:r(`common:leaderboard.deleteConfirm`,`Are you sure you want to delete this record?`),onConfirm:()=>te(e.state),children:(0,J.jsx)(_,{isIconOnly:!0,size:`sm`,variant:`light`,children:(0,J.jsx)(A,{icon:w,className:`text-danger`})})})]})})},`options`)]},e.id)}})]})})]},e)})]}),L&&C&&(0,J.jsx)(Y,{isOpen:y,onOpenChange:t=>{x(t),t||f(G,void 0,e).then(e=>{M(e)})},matching:L,mapName:C,artifacts:Q[C]||[],initialState:E,seasonId:G})]}),(0,J.jsx)(K,{})]})}export{Z as component};