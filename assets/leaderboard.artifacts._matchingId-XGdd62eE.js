import{s as e}from"./rolldown-runtime-Cb2Vi1zU.js";import{a as t,n}from"./vendor-react-Pim_c09P.js";import{$t as r,Bt as i,D as a,Ft as o,Ht as s,Jt as c,Kt as l,Mt as u,Nt as d,O as f,Pt as ee,Qt as te,St as ne,Ut as p,Vt as m,X as h,Xt as g,Yt as _,Z as v,_t as y,an as b,at as x,bt as S,cn as C,ct as w,dt as T,ft as E,it as D,jt as re,mt as O,on as k,pt as ie,qt as A,rn as j,sn as M,ut as N,vt as P,xt as F,yt as I,z as ae}from"./vendor-ui-D25gIF8s.js";import{S as L,b as R,l as oe,o as se,p as z,s as B,t as ce,v as le}from"./index-CZUkHjUW.js";import{t as V}from"./useDebounce-CKxAnxa8.js";import{t as H}from"./AdaptiveTooltip-Be-rZQ4I.js";import{t as ue}from"./Footer-X70E9Lr7.js";var U=e(t(),1),W=e(n(),1),de=({isOpen:e,onOpenChange:t,matching:n,mapName:i,initialState:a,seasonId:s})=>{let{t:c,i18n:f}=L(`common`),{createArtifactState:te,updateArtifactState:ne,artifactsByMap:m}=se(),h=(0,U.useMemo)(()=>(m[i]||[]).sort((e,t)=>e.order-t.order),[m,i]),[g,_]=(0,U.useState)(k(M())),[y,x]=(0,U.useState)(`48:00:00`),[S,E]=(0,U.useState)({}),[D,A]=(0,U.useState)(!1),[j,P]=(0,U.useState)(k(M())),[F,I]=(0,U.useState)(null),ae=e=>{let t=new Date(e).getTime(),n=Date.now(),r=t+1728e5-n;if(r<=0)return`48:00:00`;let i=Math.floor(r/(1e3*60*60)),a=Math.floor(r%(1e3*60*60)/(1e3*60)),o=Math.floor(r%(1e3*60)/1e3);return`${String(i).padStart(2,`0`)}:${String(a).padStart(2,`0`)}:${String(o).padStart(2,`0`)}`};(0,U.useEffect)(()=>{if(e)if(I(null),a)if(a.id){_(b(a.recordTime)),x(ae(a.recordTime)),P(b(a.recordTime)),A(!1);let e={};a.states.forEach(t=>{e[t.abyssArtifactId]=t.state}),E(e)}else{_(k(M())),x(`48:00:00`),P(k(M())),A(!0);let e={};a.states?a.states.forEach(t=>{e[t.abyssArtifactId]=t.state}):h.forEach(t=>{e[t.id]=1}),E(e)}else{_(k(M())),x(`48:00:00`),P(k(M())),A(!0);let e={};h.forEach(t=>{e[t.id]=1}),E(e)}},[e,a,h]);let R=(0,U.useMemo)(()=>!!(a&&a.id),[a]),oe=(0,U.useMemo)(()=>{if(!D)return j;if(!g||!y)return null;try{let e=g.toDate(),[t,n,r]=y.split(`:`).map(Number),i=((t||0)*3600+(n||0)*60+(r||0))*1e3,a=e.getTime()+i-48*3600*1e3;return b(new Date(a).toISOString())}catch{return null}},[g,y,D,j]),z=(0,U.useMemo)(()=>{if(!D)return j?new Date(j.toDate()).toISOString():``;if(!g||!y)return``;try{let e=g.toDate(),[t,n,r]=y.split(`:`).map(Number),i=((t||0)*3600+(n||0)*60+(r||0))*1e3,a=e.getTime()+i-48*3600*1e3;return new Date(a).toISOString()}catch{return``}},[g,y,D,j]),B=async()=>{let e=Object.entries(S).map(([e,t])=>({abyssArtifactId:e,state:t})),r=null;r=R&&a?await ne(s,i,a.id,{states:e,recordTime:z}):await te(s,i,{serverMatchingId:n.id,states:e,recordTime:z}),r&&r.errorCode===`Success`?t(!1):r?r.errorCode===`ValidationError`?I(c(`leaderboard.artifactState.validationError`)):I(r.errorMessage||c(`errors.unknown`)):I(c(`errors.unknown`))},ce=(e,t)=>{E(n=>({...n,[e]:t}))},le=e=>(0,W.jsxs)(`div`,{className:`flex items-center justify-between gap-4`,children:[(0,W.jsx)(`span`,{className:`text-sm flex-1`,children:c(`markers/${e.marker.mapId}:${e.markerId}.name`,e.marker.name)}),(0,W.jsxs)(ie,{size:`sm`,className:`w-[100px]`,selectedKeys:[String(S[e.id]||1)],onSelectionChange:t=>ce(e.id,Number(Array.from(t)[0])),disallowEmptySelection:!0,classNames:V,popoverProps:{radius:`none`},listboxProps:ue,children:[(0,W.jsx)(O,{textValue:c(`leaderboard.artifactState.light`),children:c(`leaderboard.artifactState.light`)},`1`),(0,W.jsx)(O,{textValue:c(`leaderboard.artifactState.dark`),children:c(`leaderboard.artifactState.dark`)},`2`)]})]},e.id),V={inputWrapper:`!bg-character-card hover:!bg-character-card focus:!bg-character-card !transition-none border-crafting-border border-1 shadow-none rounded-sm group-data-[hover=true]:!bg-character-card group-data-[focus=true]:!bg-character-card group-data-[focus-visible=true]:!bg-character-card min-h-[36px]`,popoverContent:`rounded-none p-0`,segment:`text-foreground`,trigger:`!bg-character-card hover:!bg-character-card focus:!bg-character-card !transition-none border-crafting-border border-1 shadow-none rounded-sm group-data-[hover=true]:!bg-character-card group-data-[focus=true]:!bg-character-card group-data-[focus-visible=true]:!bg-character-card min-h-[36px]`,innerWrapper:`py-0`},ue={itemClasses:{base:`rounded-none`}};return(0,W.jsx)(re,{isOpen:e,onOpenChange:t,size:`xl`,classNames:{base:`bg-character-equipment`},children:(0,W.jsx)(ee,{children:e=>(0,W.jsxs)(W.Fragment,{children:[(0,W.jsxs)(u,{children:[c(R?`leaderboard.artifactState.update`:`leaderboard.artifactState.create`),` - ${n.server1.serverName} VS ${n.server2.serverName}`]}),(0,W.jsxs)(o,{className:`gap-4`,children:[F&&(0,W.jsx)(N,{color:`danger`,variant:`flat`,onClose:()=>I(null),children:F}),(0,W.jsx)(`div`,{className:`flex items-center gap-2 mb-2`,children:(0,W.jsx)(l,{isSelected:D,onValueChange:A,size:`sm`,children:c(`leaderboard.artifactState.countdownMode`)})}),(0,W.jsx)(C,{locale:f.language,children:D?(0,W.jsxs)(W.Fragment,{children:[(0,W.jsxs)(`div`,{className:`relative group/picker`,children:[(0,W.jsx)(T,{label:c(`leaderboard.artifactState.uploadTime`),hideTimeZone:!0,showMonthAndYearPickers:!0,value:g,onChange:e=>{e&&_(e)},classNames:V,granularity:`second`}),(0,W.jsx)(H,{content:c(`common:leaderboard.resetToNow`,`重置到当前时间`),children:(0,W.jsx)(r,{size:`sm`,variant:`flat`,isIconOnly:!0,className:`absolute right-10 bottom-2 z-20 h-6 w-6 min-w-0 bg-transparent`,onClick:()=>{_(k(M()))},children:(0,W.jsx)(w,{icon:v,className:`text-[12px]`})})})]}),(0,W.jsx)(p,{label:c(`leaderboard.artifactState.countdown`),placeholder:`hh:mm:ss`,value:y,onChange:e=>x(e.target.value),classNames:V})]}):(0,W.jsx)(T,{label:c(`leaderboard.artifactState.recordTime`),hideTimeZone:!0,showMonthAndYearPickers:!0,value:j,onChange:e=>{e&&P(e)},classNames:V,granularity:`second`})}),D&&(0,W.jsx)(C,{locale:f.language,children:(0,W.jsx)(T,{label:c(`leaderboard.artifactState.recordTime`),hideTimeZone:!0,showMonthAndYearPickers:!0,value:oe,isDisabled:!0,classNames:V,granularity:`second`})}),(0,W.jsxs)(`div`,{className:`flex flex-col gap-2 mt-2`,children:[(0,W.jsx)(`p`,{className:`font-bold`,children:c(`maps:${i}.description`)}),h.map(le)]})]}),(0,W.jsxs)(d,{children:[(0,W.jsx)(r,{variant:`light`,onPress:e,children:c(`leaderboard.artifactState.cancel`)}),(0,W.jsx)(r,{color:`primary`,onPress:B,children:c(`leaderboard.artifactState.save`)})]})]})})})},fe=({children:e,title:t,onConfirm:n,confirmText:a,cancelText:o,color:c=`danger`})=>{let{t:l}=L(`common`),[u,d]=U.useState(!1);return(0,W.jsxs)(i,{isOpen:u,onOpenChange:e=>d(e),placement:`top`,children:[(0,W.jsx)(m,{children:e}),(0,W.jsx)(s,{className:`p-4`,children:(0,W.jsxs)(`div`,{className:`flex flex-col gap-4`,children:[(0,W.jsx)(`div`,{className:`text-sm font-medium`,children:t}),(0,W.jsxs)(`div`,{className:`flex justify-center gap-2`,children:[(0,W.jsx)(r,{size:`sm`,variant:`flat`,onClick:()=>d(!1),children:o||l(`ui.cancel`)}),(0,W.jsx)(r,{size:`sm`,color:c,onClick:()=>{n(),d(!1)},children:a||l(`ui.confirm`)})]})]})})]})};function G(){let{matchingId:e}=ce.useParams(),t=z(),n=[B.ABYSS_A,B.ABYSS_B],{t:i}=L([...n.map(e=>`markers/${e}`),`common`]),{user:s,isSuperUser:l,fetchWithAuth:p}=oe(),{seasons:m,serverMatchings:v,artifactsByMap:b,fetchServerMatching:C,fetchArtifactStates:T,region:k,deleteArtifactState:ie}=se(),[M,N]=(0,U.useState)(!1),[H,G]=(0,U.useState)(null),[pe,me]=(0,U.useState)(null),[he,K]=(0,U.useState)([]),[q,ge]=(0,U.useState)([]),[J,Y]=(0,U.useState)(!1),[_e,ve]=(0,U.useState)(``),[ye,be]=(0,U.useState)(``),xe=V(ye,500),[Se,X]=(0,U.useState)([]),[Ce,we]=(0,U.useState)(!1);(0,U.useEffect)(()=>{J||(ve(``),be(``),X([]))},[J]);let Z=(0,U.useMemo)(()=>v.find(t=>t.id===e),[v,e]),Q=(0,U.useMemo)(()=>{if(Z)return Z.seasonId;let e=m.filter(e=>e.serverRegion.toLowerCase()===k.toLowerCase());if(e.length===0)return null;let t=Math.max(...e.map(e=>e.number));return e.find(e=>e.number===t)?.id||null},[k,m,Z]),$=async()=>{if(!(!Q||!e))try{let t=await fetch(le(`/api/v1/seasons/${Q}/server_matchings/${e}/abyss_artifact_admins/`));if(t.ok){let e=await t.json();e.errorCode===`Success`&&ge(e.data.results)}}catch(e){console.error(`Failed to fetch admins`,e)}};(0,U.useEffect)(()=>{(async()=>{let e=xe.trim();if(!e){X([]);return}we(!0);try{let t=await p(`/users/search?name=${encodeURIComponent(e)}`);if(t.ok){let e=await t.json();e.errorCode===`Success`&&X(e.data.results)}}catch(e){console.error(`Failed to search users`,e)}finally{we(!1)}})()},[xe]);let Te=async()=>{if(!(!Q||!e||!_e))try{(await p(`/seasons/${Q}/server_matchings/${e}/abyss_artifact_admins/${_e}`,{method:`POST`})).ok&&(Y(!1),$())}catch(e){console.error(`Failed to add admin`,e)}},Ee=async t=>{if(!(!Q||!e))try{(await p(`/seasons/${Q}/server_matchings/${e}/abyss_artifact_admins/${t}`,{method:`DELETE`})).ok&&$()}catch(e){console.error(`Failed to delete admin`,e)}};(0,U.useEffect)(()=>{Q&&(Z||C(Q,e),T(Q,void 0,e).then(e=>{K(e)}),$())},[Q,e,Z,C,T]);let De=(0,U.useMemo)(()=>{let t={};return he.filter(t=>t.serverMatchingId===e).forEach(e=>{t[e.mapName]||(t[e.mapName]=[]),t[e.mapName].push(e)}),Object.keys(t).forEach(e=>{t[e].sort((e,t)=>new Date(t.recordTime).getTime()-new Date(e.recordTime).getTime())}),t},[he,e]),Oe=(0,U.useMemo)(()=>{let e={};return Object.keys(b).forEach(t=>{e[t]=[...b[t]].sort((e,t)=>e.order-t.order)}),e},[b]),ke=(e,t)=>{Z&&(G(t),me(e),N(!0))},Ae=(e,t)=>{Z&&(G(e),me(t?{...t,id:``}:null),N(!0))},je=async t=>{if(Q)try{(await p(`/seasons/${Q}/maps/${t.mapName}/artifacts/states/${t.id}/verify`,{method:`POST`})).ok&&K(await T(Q,void 0,e))}catch(e){console.error(`Failed to verify admin`,e)}},Me=async t=>{Q&&await ie(Q,t.mapName,t.id,e)&&K(await T(Q,void 0,e))},Ne=(e,t)=>{let n=new Date(e).getTime(),r=new Date(t).getTime(),a=Math.abs(n-r)-2880*60*1e3,o=a<0,s=Math.abs(a),c=Math.floor(s/(1e3*60*60)),l=Math.floor(s%(1e3*60*60)/(1e3*60)),u=Math.floor(s%(1e3*60)/1e3),d=`${String(c).padStart(2,`0`)}:${String(l).padStart(2,`0`)}:${String(u).padStart(2,`0`)}`;return o?i(`common:leaderboard.refreshedAgo`,{time:d}):d},Pe=R(`UI/Resource/Texture/Icon/UT_Marker_AbyssArtifact_Neutral.webp`),Fe=R(`UI/Resource/Texture/Icon/UT_Marker_AbyssArtifact_Light.webp`),Ie=R(`UI/Resource/Texture/Icon/UT_Marker_AbyssArtifact_Dark.webp`);return!Z&&!Q?(0,W.jsx)(`div`,{className:`p-8 text-center`,children:i(`common:ui.loading`)}):(0,W.jsxs)(`div`,{className:`min-h-full flex flex-col`,children:[(0,W.jsxs)(`div`,{className:`flex-1 flex flex-col items-center p-4`,children:[(0,W.jsxs)(`div`,{className:`w-full max-w-[1400px] flex flex-col gap-6`,children:[(0,W.jsxs)(`div`,{className:`flex items-center gap-4`,children:[(0,W.jsx)(r,{isIconOnly:!0,variant:`flat`,className:`bg-character-card border-1 border-crafting-border`,onClick:()=>t({to:`/leaderboard`}),children:(0,W.jsx)(w,{icon:a})}),(0,W.jsx)(`h1`,{className:`text-2xl font-bold`,children:Z?`${Z.server1.serverName} VS ${Z.server2.serverName}`:i(`common:leaderboard.artifactDetails`)})]}),(0,W.jsx)(_,{className:`bg-character-equipment shadow-none border-1 border-crafting-border`,children:(0,W.jsxs)(g,{className:`flex justify-between items-center px-6 py-3`,children:[(0,W.jsxs)(`div`,{className:`flex items-center gap-2`,children:[(0,W.jsx)(`span`,{className:`font-bold`,children:i(`common:leaderboard.artifactAdmins`)}),(0,W.jsxs)(`div`,{className:`flex flex-wrap gap-2`,children:[q.map(e=>(0,W.jsx)(fe,{title:i(`common:ui.confirmDelete`),onConfirm:()=>Ee(e.user.id),children:(0,W.jsx)(c,{variant:`flat`,color:`primary`,onClose:l?()=>{}:void 0,children:e.user.name||e.user.email})},e.id)),q.length===0&&(0,W.jsx)(`span`,{className:`text-sm text-default-400`,children:i(`common:ui.noData`)})]})]}),l&&(0,W.jsx)(r,{size:`sm`,color:`primary`,variant:`flat`,startContent:(0,W.jsx)(w,{icon:h}),onClick:()=>Y(!0),children:i(`common:ui.add`)})]})}),n.map(e=>{let t=De[e]||[],n=Oe[e]||[];return(0,W.jsxs)(_,{className:`bg-character-equipment shadow-none border-1 border-crafting-border`,children:[(0,W.jsxs)(g,{className:`flex justify-between items-center px-6 py-4`,children:[(0,W.jsx)(`h2`,{className:`text-xl font-bold`,children:i(`maps:${e}.description`)}),s&&(0,W.jsx)(r,{size:`sm`,color:`default`,variant:`flat`,startContent:(0,W.jsx)(w,{icon:h}),onClick:()=>Ae(e),children:i(`common:leaderboard.artifactState.create`)})]}),(0,W.jsx)(j,{}),(0,W.jsx)(te,{className:`p-0 overflow-x-auto`,children:(0,W.jsxs)(ne,{"aria-label":`Artifact states for ${e}`,className:`min-w-full`,removeWrapper:!0,classNames:{th:`bg-character-card text-foreground border-b border-crafting-border first:rounded-none last:rounded-none`,td:`py-3 px-4 border-b border-crafting-border/50`},children:[(0,W.jsx)(S,{columns:[{id:`recordTime`,label:i(`common:leaderboard.artifactState.recordTime`),width:200},...n.map(t=>({id:t.id,label:i(`markers/${e}:${t.markerId}.name`,{defaultValue:t.marker.name}),isArtifact:!0})),{id:`is_verified`,label:i(`common:leaderboard.artifactState.isVerified`),width:100},{id:`contributors`,label:i(`common:leaderboard.artifactState.contributors`),width:200},{id:`options`,label:i(`common:leaderboard.options`),width:100}],children:e=>(0,W.jsx)(F,{width:e.width,align:`center`,children:e.isArtifact?(0,W.jsx)(`div`,{className:`flex flex-col items-center gap-1 min-w-[120px]`,children:(0,W.jsx)(`span`,{className:`text-[12px] whitespace-nowrap overflow-hidden text-ellipsis max-w-[120px]`,children:e.label})}):e.label},e.id)}),(0,W.jsx)(P,{emptyContent:i(`common:ui.noData`),items:t.flatMap((r,i)=>{let a=[];if(a.push({type:`data`,id:r.id,state:r,mapName:e,arts:n}),i<t.length-1){let e=t[i+1];a.push({type:`diff`,id:`diff-${r.id}-${e.id}`,state:r,nextState:e,arts:n})}return a}),children:e=>{if(e.type===`diff`){let t=Ne(e.state.recordTime,e.nextState.recordTime);return(0,W.jsx)(I,{className:`bg-default-50/30`,children:(0,W.jsx)(y,{colSpan:n.length+4,children:(0,W.jsx)(`div`,{className:`flex justify-center items-center px-4 py-1`,children:(0,W.jsxs)(`span`,{className:`text-sm text-default-800 italic text-center`,children:[i(`common:leaderboard.timeDiffToNext`),`: `,t]})})})},e.id)}return(0,W.jsxs)(I,{children:[(0,W.jsx)(y,{children:(0,W.jsx)(`div`,{className:`flex flex-col`,children:(0,W.jsx)(`span`,{className:`font-medium`,children:new Date(e.state.recordTime).toLocaleString()})})},`recordTime`),e.arts.map(t=>{let n=e.state.states.find(e=>e.abyssArtifactId===t.id);return(0,W.jsx)(y,{children:(0,W.jsx)(`div`,{className:`flex justify-center`,children:(0,W.jsx)(`img`,{src:n?.state===1?Fe:n?.state===2?Ie:Pe,alt:`state`,className:`w-10 h-10`})})},t.id)}),(0,W.jsx)(y,{children:(0,W.jsx)(`div`,{className:`flex justify-center`,children:(0,W.jsx)(w,{icon:e.state.isVerified?f:D,className:e.state.isVerified?`text-success`:`text-default-400`})})},`is_verified`),(0,W.jsx)(y,{children:(0,W.jsx)(`div`,{className:`flex flex-col items-center gap-1`,children:e.state.contributors&&e.state.contributors.length>0?e.state.contributors.map(e=>(0,W.jsx)(`span`,{className:`text-xs text-primary bg-primary/10 px-2 py-0.5 rounded-full`,children:e.user.name},e.id)):(0,W.jsx)(`span`,{className:`text-xs text-default-400`,children:`-`})})},`contributors`),(0,W.jsx)(y,{children:(0,W.jsx)(`div`,{className:`flex justify-center gap-2`,children:(()=>{let t=e.state.contributors?.some(e=>e.userId===s?.id),n=q.some(e=>e.user.id===s?.id),a=l||n||t,o=l||n;return(0,W.jsxs)(W.Fragment,{children:[(l||n)&&!e.state.isVerified&&(0,W.jsx)(A,{content:i(`common:leaderboard.artifactState.verify`),children:(0,W.jsx)(r,{isIconOnly:!0,size:`sm`,variant:`light`,onClick:()=>je(e.state),children:(0,W.jsx)(w,{icon:f,className:`text-success`})})}),a&&(0,W.jsx)(A,{content:i(`common:ui.edit`),children:(0,W.jsx)(r,{isIconOnly:!0,size:`sm`,variant:`light`,onClick:()=>ke(e.state,e.mapName),children:(0,W.jsx)(w,{icon:ae,className:`text-primary`})})}),o&&(0,W.jsx)(fe,{title:i(`common:leaderboard.deleteConfirm`,`Are you sure you want to delete this record?`),onConfirm:()=>Me(e.state),children:(0,W.jsx)(r,{isIconOnly:!0,size:`sm`,variant:`light`,children:(0,W.jsx)(w,{icon:x,className:`text-danger`})})})]})})()})},`options`)]},e.id)}})]})})]},e)})]}),Z&&H&&(0,W.jsx)(de,{isOpen:M,onOpenChange:t=>{N(t),t||T(Q,void 0,e).then(e=>{K(e)})},matching:Z,mapName:H,artifacts:Oe[H]||[],initialState:pe,seasonId:Q}),(0,W.jsx)(re,{isOpen:J,onOpenChange:Y,children:(0,W.jsx)(ee,{className:`bg-character-card`,children:e=>(0,W.jsxs)(W.Fragment,{children:[(0,W.jsx)(u,{className:`flex flex-col gap-1`,children:i(`common:leaderboard.addArtifactAdmin`)}),(0,W.jsx)(o,{children:(0,W.jsx)(E,{autoFocus:!0,label:i(`common:auth.username`),placeholder:i(`common:ui.search`),variant:`bordered`,items:Se,isLoading:Ce,inputValue:ye,onInputChange:be,onSelectionChange:e=>ve(String(e)),children:e=>(0,W.jsx)(O,{textValue:e.name||e.email,children:(0,W.jsxs)(`div`,{className:`flex flex-col`,children:[(0,W.jsx)(`span`,{className:`text-sm font-medium`,children:e.name||`No Name`}),(0,W.jsx)(`span`,{className:`text-xs text-default-800`,children:e.email})]})},e.id)})}),(0,W.jsxs)(d,{children:[(0,W.jsx)(r,{color:`danger`,variant:`flat`,onPress:e,children:i(`common:ui.cancel`)}),(0,W.jsx)(r,{color:`primary`,onPress:Te,children:i(`common:ui.add`)})]})]})})})]}),(0,W.jsx)(ue,{})]})}export{G as component};