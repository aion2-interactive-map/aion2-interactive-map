import{s as e}from"./rolldown-runtime-Cb2Vi1zU.js";import{a as t,n}from"./vendor-react-Pim_c09P.js";import{$t as r,B as i,Ct as a,D as o,Ft as s,Ht as c,It as l,Jt as u,Mt as d,Nt as f,O as p,Pt as m,Qt as h,St as g,Ut as _,Vt as v,Xt as y,Yt as b,Z as x,an as S,at as C,bt as w,cn as T,dt as E,ft as D,ht as O,ln as k,lt as A,mt as j,on as M,ot as N,pt as P,qt as F,rn as I,sn as L,vt as R,xt as z,yt as B}from"./vendor-ui-1_exp9nm.js";import{S as V,b as H,h as U,l as W,o as G,p as K,s as q,t as J,v as ee}from"./index-CW0fNsuF.js";import{t as Y}from"./useDebounce-CKxAnxa8.js";import{t as te}from"./Footer-Dlt9vdvZ.js";var X=e(t(),1),Z=e(n(),1),ne=({isOpen:e,onOpenChange:t,matching:n,mapName:i,initialState:a,seasonId:o})=>{let{t:c,i18n:u}=V(`common`),{createArtifactState:p,updateArtifactState:h,artifactsByMap:g}=G(),_=(0,X.useMemo)(()=>(g[i]||[]).sort((e,t)=>e.order-t.order),[g,i]),[v,y]=(0,X.useState)({}),[b,x]=(0,X.useState)(null),[C,w]=(0,X.useState)(null),A=(0,X.useCallback)(e=>{let t=new Date(Date.UTC(e.year,e.month-1,e.day,13,0,0)).getUTCDay();return t!==2&&t!==4&&t!==6},[]),N=(0,X.useCallback)(()=>{let e=L(T()),t=M(e);for(let e=0;e<7;e++){if(!A(t))return t;t=t.subtract({days:1})}return M(e)},[A]);(0,X.useEffect)(()=>{if(e)if(w(null),a)if(a.id){x(M(S(a.recordTime)));let e={};a.states.forEach(t=>{e[t.abyssArtifactId]=t.state}),y(e)}else{x(N());let e={};a.states?a.states.forEach(t=>{e[t.abyssArtifactId]=t.state}):_.forEach(t=>{e[t.id]=1}),y(e)}else{x(N());let e={};_.forEach(t=>{e[t.id]=1}),y(e)}},[e]);let P=(0,X.useMemo)(()=>!!(a&&a.id),[a]),F=(0,X.useMemo)(()=>b?new Date(Date.UTC(b.year,b.month-1,b.day,13,0,0)).toISOString():``,[b]),I=(0,X.useMemo)(()=>{let e=new Date;return e.setUTCHours(13,0,0,0),e.toLocaleTimeString(u.language,{hour:`2-digit`,minute:`2-digit`,hour12:!1})},[u.language]),R=async()=>{let e=Object.entries(v).map(([e,t])=>({abyssArtifactId:e,state:t})),r=null;r=P&&a?await h(o,i,a.id,{states:e,recordTime:F}):await p(o,i,{serverMatchingId:n.id,states:e,recordTime:F}),r&&r.errorCode===`Success`?t(!1):r?r.errorCode===`ValidationError`?w(c(`leaderboard.artifactState.validationError`)):w(r.errorMessage||c(`errors.unknown`)):w(c(`errors.unknown`))},z=(e,t)=>{y(n=>({...n,[e]:t}))},B=e=>(0,Z.jsxs)(`div`,{className:`flex items-center justify-between gap-4`,children:[(0,Z.jsx)(`span`,{className:`text-sm flex-1`,children:c(`markers/${e.marker.mapId}:${e.markerId}.name`,e.marker.name)}),(0,Z.jsxs)(j,{size:`sm`,className:`w-[100px]`,selectedKeys:[String(v[e.id]||1)],onSelectionChange:t=>{let n=Array.from(t)[0];n!==void 0&&z(e.id,Number(n))},disallowEmptySelection:!0,classNames:H,popoverProps:{radius:`none`},listboxProps:U,children:[(0,Z.jsx)(O,{textValue:c(`leaderboard.artifactState.light`),children:c(`leaderboard.artifactState.light`)},`1`),(0,Z.jsx)(O,{textValue:c(`leaderboard.artifactState.dark`),children:c(`leaderboard.artifactState.dark`)},`2`)]})]},e.id),H={inputWrapper:`!bg-character-card hover:!bg-character-card focus:!bg-character-card !transition-none border-crafting-border border-1 shadow-none rounded-sm group-data-[hover=true]:!bg-character-card group-data-[focus=true]:!bg-character-card group-data-[focus-visible=true]:!bg-character-card min-h-[36px]`,popoverContent:`rounded-none p-0`,segment:`text-foreground`,trigger:`!bg-character-card hover:!bg-character-card focus:!bg-character-card !transition-none border-crafting-border border-1 shadow-none rounded-sm group-data-[hover=true]:!bg-character-card group-data-[focus=true]:!bg-character-card group-data-[focus-visible=true]:!bg-character-card min-h-[36px]`,innerWrapper:`py-0`},U={itemClasses:{base:`rounded-none`}};return(0,Z.jsx)(d,{isOpen:e,onOpenChange:t,size:`xl`,classNames:{base:`bg-character-equipment`},children:(0,Z.jsx)(s,{children:e=>(0,Z.jsxs)(Z.Fragment,{children:[(0,Z.jsxs)(f,{children:[c(P?`leaderboard.artifactState.update`:`leaderboard.artifactState.create`),` - ${n.server1.serverName} VS ${n.server2.serverName}`]}),(0,Z.jsxs)(l,{className:`gap-4`,children:[C&&(0,Z.jsx)(E,{color:`danger`,variant:`flat`,onClose:()=>w(null),children:C}),(0,Z.jsx)(k,{locale:u.language,children:(0,Z.jsx)(D,{label:c(`leaderboard.artifactState.recordTime`),hideTimeZone:!0,showMonthAndYearPickers:!0,value:b,onChange:e=>{e&&x(e)},isDateUnavailable:A,classNames:H,description:c(`leaderboard.artifactState.timeFixedNote`,{time:I})})}),(0,Z.jsxs)(`div`,{className:`flex flex-col gap-2 mt-2`,children:[(0,Z.jsx)(`p`,{className:`font-bold`,children:c(`maps:${i}.description`)}),_.map(B)]})]}),(0,Z.jsxs)(m,{children:[(0,Z.jsx)(r,{variant:`light`,onPress:e,children:c(`leaderboard.artifactState.cancel`)}),(0,Z.jsx)(r,{color:`primary`,onPress:R,children:c(`leaderboard.artifactState.save`)})]})]})})})},Q=({children:e,title:t,onConfirm:n,confirmText:i,cancelText:a,color:o=`danger`})=>{let{t:s}=V(`common`),[l,u]=X.useState(!1);return(0,Z.jsxs)(v,{isOpen:l,onOpenChange:e=>u(e),placement:`top`,children:[(0,Z.jsx)(c,{children:e}),(0,Z.jsx)(_,{className:`p-4`,children:(0,Z.jsxs)(`div`,{className:`flex flex-col gap-4`,children:[(0,Z.jsx)(`div`,{className:`text-sm font-medium`,children:t}),(0,Z.jsxs)(`div`,{className:`flex justify-center gap-2`,children:[(0,Z.jsx)(r,{size:`sm`,variant:`flat`,onClick:()=>u(!1),children:a||s(`ui.cancel`)}),(0,Z.jsx)(r,{size:`sm`,color:o,onClick:()=>{n(),u(!1)},children:i||s(`ui.confirm`)})]})]})})]})},re=({admin:e,isSuperUser:t,onDelete:n,t:r})=>(0,Z.jsx)(Q,{title:r(`common:ui.confirmDelete`),onConfirm:()=>n(e.user.id),children:(0,Z.jsx)(u,{variant:`flat`,color:`primary`,onClose:t?()=>{}:void 0,children:e.user.name||e.user.email})}),ie=({isOpen:e,onOpenChange:t,onAddAdmin:n,fetchWithAuth:i,t:a})=>{let[o,c]=(0,X.useState)(``),[u,p]=(0,X.useState)(``),h=Y(u,500),[g,_]=(0,X.useState)([]),[v,y]=(0,X.useState)(!1);return(0,X.useEffect)(()=>{e||(c(``),p(``),_([]))},[e]),(0,X.useEffect)(()=>{(async()=>{let e=h.trim();if(!e){_([]);return}y(!0);try{let t=await i(`/users/search?name=${encodeURIComponent(e)}`);if(t.ok){let e=await t.json();e.errorCode===`Success`&&_(e.data.results)}}catch(e){console.error(`Failed to search users`,e)}finally{y(!1)}})()},[h,i]),(0,Z.jsx)(d,{isOpen:e,onOpenChange:t,children:(0,Z.jsx)(s,{className:`bg-character-card`,children:e=>(0,Z.jsxs)(Z.Fragment,{children:[(0,Z.jsx)(f,{className:`flex flex-col gap-1`,children:a(`common:leaderboard.addArtifactAdmin`)}),(0,Z.jsx)(l,{children:(0,Z.jsx)(P,{autoFocus:!0,label:a(`common:auth.username`),placeholder:a(`common:ui.search`),variant:`bordered`,items:g,isLoading:v,inputValue:u,onInputChange:p,onSelectionChange:e=>c(String(e)),children:e=>(0,Z.jsx)(O,{textValue:e.name||e.email,children:(0,Z.jsxs)(`div`,{className:`flex flex-col`,children:[(0,Z.jsx)(`span`,{className:`text-sm font-medium`,children:e.name||`No Name`}),(0,Z.jsx)(`span`,{className:`text-xs text-default-800`,children:e.email})]})},e.id)})}),(0,Z.jsxs)(m,{children:[(0,Z.jsx)(r,{color:`danger`,variant:`flat`,onPress:e,children:a(`common:ui.cancel`)}),(0,Z.jsx)(r,{color:`primary`,onPress:()=>n(o),children:a(`common:ui.add`)})]})]})})})},ae=({states:e,arts:t,mapName:n,admins:o,user:s,isSuperUser:c,onVerify:l,onEdit:u,onDelete:d,icons:f,t:m})=>(0,Z.jsxs)(a,{"aria-label":`Artifact states for ${n}`,className:`min-w-full`,removeWrapper:!0,classNames:{base:`bg-transparent`,table:`bg-transparent`,thead:`bg-transparent`,th:`bg-[#FFFFFF]/40 text-foreground border-b border-crafting-border first:rounded-none last:rounded-none text-[16px] backdrop-blur-sm`,td:`py-3 px-4 border-b border-crafting-border/50`,tr:`bg-character-equipment`},children:[(0,Z.jsx)(z,{columns:[{id:`recordTime`,label:m(`common:leaderboard.artifactState.recordTime`),width:200},...t.map(e=>({id:e.id,label:m(`markers/${n}:${e.markerId}.name`,{defaultValue:e.marker.name}),isArtifact:!0})),{id:`is_verified`,label:m(`common:leaderboard.artifactState.isVerified`),width:100},{id:`contributors`,label:m(`common:leaderboard.artifactState.contributors`),width:200},{id:`options`,label:m(`common:leaderboard.options`),width:100}],children:e=>(0,Z.jsx)(g,{width:e.width,align:`center`,children:e.isArtifact?(0,Z.jsx)(`div`,{className:`flex flex-col items-center gap-1 min-w-[160px]`,children:(0,Z.jsx)(`span`,{className:`text-base whitespace-nowrap overflow-hidden text-ellipsis max-w-[160px]`,children:e.label})}):e.label},e.id)}),(0,Z.jsx)(B,{emptyContent:m(`common:ui.noData`),items:e.map(e=>({type:`data`,id:e.id,state:e,mapName:n,arts:t})),children:e=>(0,Z.jsxs)(w,{children:[(0,Z.jsx)(R,{children:(0,Z.jsx)(`div`,{className:`flex flex-col`,children:(0,Z.jsx)(`span`,{className:`text-base text-default-800`,children:U(e.state.recordTime).format(`YYYY/M/D HH:mm:ss`)})})},`recordTime`),e.arts.map(t=>{let n=e.state.states.find(e=>e.abyssArtifactId===t.id);return(0,Z.jsx)(R,{children:(0,Z.jsx)(`div`,{className:`flex justify-center`,children:(0,Z.jsx)(`img`,{src:n?.state===1?f.light:n?.state===2?f.dark:f.neutral,alt:`state`,className:`w-10 h-10`})})},t.id)}),(0,Z.jsx)(R,{children:(0,Z.jsx)(`div`,{className:`flex justify-center`,children:(0,Z.jsx)(A,{icon:e.state.isVerified?p:C,className:e.state.isVerified?`text-success`:`text-default-400`})})},`is_verified`),(0,Z.jsx)(R,{children:(0,Z.jsx)(`div`,{className:`flex flex-col items-center gap-1`,children:e.state.contributors&&e.state.contributors.length>0?e.state.contributors.map(e=>(0,Z.jsx)(`span`,{className:`text-xs text-primary bg-primary/10 px-2 py-0.5 rounded-full`,children:e.user.name},e.id)):(0,Z.jsx)(`span`,{className:`text-xs text-default-400`,children:`-`})})},`contributors`),(0,Z.jsx)(R,{children:(0,Z.jsx)(`div`,{className:`flex justify-center gap-2`,children:(()=>{let t=e.state.contributors?.some(e=>e.userId===s?.id),n=o.some(e=>e.user.id===s?.id),a=c||n||t,f=c||n;return(0,Z.jsxs)(Z.Fragment,{children:[(c||n)&&!e.state.isVerified&&(0,Z.jsx)(F,{content:m(`common:leaderboard.artifactState.verify`),children:(0,Z.jsx)(r,{isIconOnly:!0,size:`sm`,variant:`light`,onClick:()=>l(e.state),children:(0,Z.jsx)(A,{icon:p,className:`text-success`})})}),a&&(0,Z.jsx)(F,{content:m(`common:ui.edit`),children:(0,Z.jsx)(r,{isIconOnly:!0,size:`sm`,variant:`light`,onClick:()=>u(e.state,e.mapName),children:(0,Z.jsx)(A,{icon:i,className:`text-primary`})})}),f&&(0,Z.jsx)(Q,{title:m(`common:leaderboard.deleteConfirm`,`Are you sure you want to delete this record?`),onConfirm:()=>d(e.state),children:(0,Z.jsx)(r,{isIconOnly:!0,size:`sm`,variant:`light`,children:(0,Z.jsx)(A,{icon:N,className:`text-danger`})})})]})})()})},`options`)]},e.id)})]}),oe=({matching:e,t})=>{let n=K();return(0,Z.jsxs)(`div`,{className:`flex items-center gap-4`,children:[(0,Z.jsx)(r,{isIconOnly:!0,variant:`flat`,className:`bg-character-card border-1 border-crafting-border`,onClick:()=>n({to:`/leaderboard`}),children:(0,Z.jsx)(A,{icon:o})}),(0,Z.jsx)(`h1`,{className:`text-2xl font-bold`,children:e?(0,Z.jsxs)(Z.Fragment,{children:[(0,Z.jsx)(`span`,{className:`text-primary`,children:e.server1.serverName}),(0,Z.jsx)(`span`,{className:`mx-2`,children:`VS`}),(0,Z.jsx)(`span`,{className:`text-secondary`,children:e.server2.serverName})]}):t(`common:leaderboard.artifactDetails`)})]})};function $(){let{matchingId:e}=J.useParams(),t=[q.ABYSS_A,q.ABYSS_B],{t:n}=V([...t.map(e=>`markers/${e}`),`common`]),{user:i,isSuperUser:a,fetchWithAuth:o}=W(),{seasons:s,serverMatchings:c,artifactsByMap:l,fetchServerMatching:u,fetchArtifactStates:d,region:f,deleteArtifactState:p}=G(),[m,g]=(0,X.useState)(!1),[_,v]=(0,X.useState)(null),[S,C]=(0,X.useState)(null),[w,T]=(0,X.useState)([]),[E,D]=(0,X.useState)([]),[O,k]=(0,X.useState)(!1),j=(0,X.useMemo)(()=>c.find(t=>t.id===e),[c,e]),M=(0,X.useMemo)(()=>{if(j)return j.seasonId;let e=s.filter(e=>e.serverRegion.toLowerCase()===f.toLowerCase());if(e.length===0)return null;let t=Math.max(...e.map(e=>e.number));return e.find(e=>e.number===t)?.id||null},[f,s,j]),N=async()=>{if(!(!M||!e))try{let t=await fetch(ee(`/api/v1/seasons/${M}/server_matchings/${e}/abyss_artifact_admins/`));if(t.ok){let e=await t.json();e.errorCode===`Success`&&D(e.data.results)}}catch(e){console.error(`Failed to fetch admins`,e)}},P=async t=>{if(!(!M||!e||!t))try{(await o(`/seasons/${M}/server_matchings/${e}/abyss_artifact_admins/${t}`,{method:`POST`})).ok&&(k(!1),N())}catch(e){console.error(`Failed to add admin`,e)}},F=async t=>{if(!(!M||!e))try{(await o(`/seasons/${M}/server_matchings/${e}/abyss_artifact_admins/${t}`,{method:`DELETE`})).ok&&N()}catch(e){console.error(`Failed to delete admin`,e)}};(0,X.useEffect)(()=>{M&&(j||u(M,e),d(M,void 0,e).then(e=>{T(e)}),N())},[M,e,j,u,d]);let L=(0,X.useMemo)(()=>{let t={};return w.filter(t=>t.serverMatchingId===e).forEach(e=>{t[e.mapName]||(t[e.mapName]=[]),t[e.mapName].push(e)}),Object.keys(t).forEach(e=>{t[e].sort((e,t)=>new Date(t.recordTime).getTime()-new Date(e.recordTime).getTime())}),t},[w,e]),R=(0,X.useMemo)(()=>{let e={};return Object.keys(l).forEach(t=>{e[t]=[...l[t]].sort((e,t)=>e.order-t.order)}),e},[l]),z=(e,t)=>{j&&(v(t),C(e),g(!0))},B=(e,t)=>{j&&(v(e),C(t?{...t,id:``}:null),g(!0))},U=async t=>{if(M)try{(await o(`/seasons/${M}/maps/${t.mapName}/artifacts/states/${t.id}/verify`,{method:`POST`})).ok&&T(await d(M,void 0,e))}catch(e){console.error(`Failed to verify admin`,e)}},K=async t=>{M&&await p(M,t.mapName,t.id,e)&&T(await d(M,void 0,e))},Y=H(`UI/Resource/Texture/Icon/UT_Marker_AbyssArtifact_Neutral.webp`),Q=H(`UI/Resource/Texture/Icon/UT_Marker_AbyssArtifact_Light.webp`),$=H(`UI/Resource/Texture/Icon/UT_Marker_AbyssArtifact_Dark.webp`);return!j&&!M?(0,Z.jsx)(`div`,{className:`p-8 text-center`,children:n(`common:ui.loading`)}):(0,Z.jsxs)(`div`,{className:`min-h-full flex flex-col`,children:[(0,Z.jsxs)(`div`,{className:`flex-1 flex flex-col items-center p-4`,children:[(0,Z.jsxs)(`div`,{className:`w-full max-w-[1400px] flex flex-col gap-6`,children:[(0,Z.jsx)(oe,{matching:j,t:n}),(0,Z.jsx)(b,{className:`bg-transparent shadow-none border-1 border-crafting-border backdrop-blur-sm`,children:(0,Z.jsxs)(y,{className:`flex justify-between items-center px-6 py-3`,children:[(0,Z.jsxs)(`div`,{className:`flex items-center gap-2`,children:[(0,Z.jsx)(`span`,{className:`font-bold`,children:n(`common:leaderboard.artifactAdmins`)}),(0,Z.jsxs)(`div`,{className:`flex flex-wrap gap-2`,children:[E.map(e=>(0,Z.jsx)(re,{admin:e,isSuperUser:a,onDelete:F,t:n},e.id)),E.length===0&&(0,Z.jsx)(`span`,{className:`text-sm text-default-400`,children:n(`common:ui.noData`)})]})]}),a&&(0,Z.jsx)(r,{size:`sm`,color:`primary`,variant:`flat`,startContent:(0,Z.jsx)(A,{icon:x}),onClick:()=>k(!0),children:n(`common:ui.add`)})]})}),t.map(e=>{let t=L[e]||[],o=R[e]||[];return(0,Z.jsxs)(b,{className:`bg-transparent shadow-none border-1 border-crafting-border backdrop-blur-sm`,children:[(0,Z.jsxs)(y,{className:`flex justify-between items-center px-6 py-4 bg-character-equipment`,children:[(0,Z.jsx)(`h2`,{className:`text-xl font-bold`,children:n(`maps:${e}.description`)}),i&&(0,Z.jsx)(r,{size:`sm`,color:`default`,variant:`flat`,startContent:(0,Z.jsx)(A,{icon:x}),onClick:()=>B(e),children:n(`common:leaderboard.artifactState.create`)})]}),(0,Z.jsx)(I,{}),(0,Z.jsx)(h,{className:`p-0 overflow-x-auto`,children:(0,Z.jsx)(ae,{states:t,arts:o,mapName:e,admins:E,user:i,isSuperUser:a,onVerify:U,onEdit:z,onDelete:K,icons:{neutral:Y,light:Q,dark:$},t:n})})]},e)})]}),j&&_&&(0,Z.jsx)(ne,{isOpen:m,onOpenChange:t=>{g(t),t||d(M,void 0,e).then(e=>{T(e)})},matching:j,mapName:_,artifacts:R[_]||[],initialState:S,seasonId:M}),(0,Z.jsx)(ie,{isOpen:O,onOpenChange:k,onAddAdmin:P,fetchWithAuth:o,t:n})]}),(0,Z.jsx)(te,{})]})}export{$ as component};