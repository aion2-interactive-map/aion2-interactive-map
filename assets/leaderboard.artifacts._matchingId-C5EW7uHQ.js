import{s as e}from"./rolldown-runtime-Cb2Vi1zU.js";import{a as t,n}from"./vendor-react-Pim_c09P.js";import{At as r,Bt as i,D as a,Gt as o,Jt as s,Kt as c,Mt as l,Nt as ee,O as u,Pt as te,Vt as d,X as f,Xt as p,Zt as m,_t as h,an as g,bt as _,dt as v,ft as y,gt as b,in as x,it as S,jt as ne,lt as C,on as w,pt as T,qt as E,rn as D,rt as O,sn as k,st as A,tn as j,ut as M,vt as N,xt as re,yt as P,z as F,zt as I}from"./vendor-ui-baGiFta6.js";import{S as L,b as R,l as ie,o as z,p as ae,s as oe,t as se,v as ce}from"./index-BzPlsON4.js";import{t as le}from"./useDebounce-CKxAnxa8.js";import{t as ue}from"./Footer-eCwWR5xq.js";var B=e(t(),1),V=e(n(),1),de=({isOpen:e,onOpenChange:t,matching:n,mapName:i,initialState:a,seasonId:o})=>{let{t:s,i18n:c}=L(`common`),{createArtifactState:u,updateArtifactState:d,artifactsByMap:f}=z(),p=(0,B.useMemo)(()=>(f[i]||[]).sort((e,t)=>e.order-t.order),[f,i]),[h,_]=(0,B.useState)({}),[v,b]=(0,B.useState)(null),[S,E]=(0,B.useState)(null),O=(0,B.useCallback)(e=>{let t=new Date(Date.UTC(e.year,e.month-1,e.day,13,0,0)).getUTCDay();return t!==2&&t!==4&&t!==6},[]),A=(0,B.useCallback)(()=>{let e=g(w()),t=x(e);for(let e=0;e<7;e++){if(!O(t))return t;t=t.subtract({days:1})}return x(e)},[O]);(0,B.useEffect)(()=>{if(e)if(E(null),a)if(a.id){b(x(D(a.recordTime)));let e={};a.states.forEach(t=>{e[t.abyssArtifactId]=t.state}),_(e)}else{b(A());let e={};a.states?a.states.forEach(t=>{e[t.abyssArtifactId]=t.state}):p.forEach(t=>{e[t.id]=1}),_(e)}else{b(A());let e={};p.forEach(t=>{e[t.id]=1}),_(e)}},[e]);let j=(0,B.useMemo)(()=>!!(a&&a.id),[a]),N=(0,B.useMemo)(()=>v?new Date(Date.UTC(v.year,v.month-1,v.day,13,0,0)).toISOString():``,[v]),re=(0,B.useMemo)(()=>{let e=new Date;return e.setUTCHours(13,0,0,0),e.toLocaleTimeString(c.language,{hour:`2-digit`,minute:`2-digit`,hour12:!1})},[c.language]),P=async()=>{let e=Object.entries(h).map(([e,t])=>({abyssArtifactId:e,state:t})),r=null;r=j&&a?await d(o,i,a.id,{states:e,recordTime:N}):await u(o,i,{serverMatchingId:n.id,states:e,recordTime:N}),r&&r.errorCode===`Success`?t(!1):r?r.errorCode===`ValidationError`?E(s(`leaderboard.artifactState.validationError`)):E(r.errorMessage||s(`errors.unknown`)):E(s(`errors.unknown`))},F=(e,t)=>{_(n=>({...n,[e]:t}))},I=e=>(0,V.jsxs)(`div`,{className:`flex items-center justify-between gap-4`,children:[(0,V.jsx)(`span`,{className:`text-sm flex-1`,children:s(`markers/${e.marker.mapId}:${e.markerId}.name`,e.marker.name)}),(0,V.jsxs)(y,{size:`sm`,className:`w-[100px]`,selectedKeys:[String(h[e.id]||1)],onSelectionChange:t=>{let n=Array.from(t)[0];n!==void 0&&F(e.id,Number(n))},disallowEmptySelection:!0,classNames:R,popoverProps:{radius:`none`},listboxProps:ie,children:[(0,V.jsx)(T,{textValue:s(`leaderboard.artifactState.light`),children:s(`leaderboard.artifactState.light`)},`1`),(0,V.jsx)(T,{textValue:s(`leaderboard.artifactState.dark`),children:s(`leaderboard.artifactState.dark`)},`2`)]})]},e.id),R={inputWrapper:`!bg-character-card hover:!bg-character-card focus:!bg-character-card !transition-none border-crafting-border border-1 shadow-none rounded-sm group-data-[hover=true]:!bg-character-card group-data-[focus=true]:!bg-character-card group-data-[focus-visible=true]:!bg-character-card min-h-[36px]`,popoverContent:`rounded-none p-0`,segment:`text-foreground`,trigger:`!bg-character-card hover:!bg-character-card focus:!bg-character-card !transition-none border-crafting-border border-1 shadow-none rounded-sm group-data-[hover=true]:!bg-character-card group-data-[focus=true]:!bg-character-card group-data-[focus-visible=true]:!bg-character-card min-h-[36px]`,innerWrapper:`py-0`},ie={itemClasses:{base:`rounded-none`}};return(0,V.jsx)(r,{isOpen:e,onOpenChange:t,size:`xl`,classNames:{base:`bg-character-equipment`},children:(0,V.jsx)(ee,{children:e=>(0,V.jsxs)(V.Fragment,{children:[(0,V.jsxs)(ne,{children:[s(j?`leaderboard.artifactState.update`:`leaderboard.artifactState.create`),` - ${n.server1.serverName} VS ${n.server2.serverName}`]}),(0,V.jsxs)(te,{className:`gap-4`,children:[S&&(0,V.jsx)(C,{color:`danger`,variant:`flat`,onClose:()=>E(null),children:S}),(0,V.jsx)(k,{locale:c.language,children:(0,V.jsx)(M,{label:s(`leaderboard.artifactState.recordTime`),hideTimeZone:!0,showMonthAndYearPickers:!0,value:v,onChange:e=>{e&&b(e)},isDateUnavailable:O,classNames:R,description:s(`leaderboard.artifactState.timeFixedNote`,{time:re})})}),(0,V.jsxs)(`div`,{className:`flex flex-col gap-2 mt-2`,children:[(0,V.jsx)(`p`,{className:`font-bold`,children:s(`maps:${i}.description`)}),p.map(I)]})]}),(0,V.jsxs)(l,{children:[(0,V.jsx)(m,{variant:`light`,onPress:e,children:s(`leaderboard.artifactState.cancel`)}),(0,V.jsx)(m,{color:`primary`,onPress:P,children:s(`leaderboard.artifactState.save`)})]})]})})})},H=({children:e,title:t,onConfirm:n,confirmText:r,cancelText:a,color:o=`danger`})=>{let{t:s}=L(`common`),[c,l]=B.useState(!1);return(0,V.jsxs)(I,{isOpen:c,onOpenChange:e=>l(e),placement:`top`,children:[(0,V.jsx)(i,{children:e}),(0,V.jsx)(d,{className:`p-4`,children:(0,V.jsxs)(`div`,{className:`flex flex-col gap-4`,children:[(0,V.jsx)(`div`,{className:`text-sm font-medium`,children:t}),(0,V.jsxs)(`div`,{className:`flex justify-center gap-2`,children:[(0,V.jsx)(m,{size:`sm`,variant:`flat`,onClick:()=>l(!1),children:a||s(`ui.cancel`)}),(0,V.jsx)(m,{size:`sm`,color:o,onClick:()=>{n(),l(!1)},children:r||s(`ui.confirm`)})]})]})})]})};function U(){let{matchingId:e}=se.useParams(),t=ae(),n=[oe.ABYSS_A,oe.ABYSS_B],{t:i}=L([...n.map(e=>`markers/${e}`),`common`]),{user:d,isSuperUser:g,fetchWithAuth:y}=ie(),{seasons:x,serverMatchings:C,artifactsByMap:w,fetchServerMatching:D,fetchArtifactStates:k,region:M,deleteArtifactState:I}=z(),[U,W]=(0,B.useState)(!1),[G,fe]=(0,B.useState)(null),[pe,me]=(0,B.useState)(null),[he,K]=(0,B.useState)([]),[q,ge]=(0,B.useState)([]),[J,Y]=(0,B.useState)(!1),[_e,ve]=(0,B.useState)(``),[ye,be]=(0,B.useState)(``),xe=le(ye,500),[Se,X]=(0,B.useState)([]),[Ce,we]=(0,B.useState)(!1);(0,B.useEffect)(()=>{J||(ve(``),be(``),X([]))},[J]);let Z=(0,B.useMemo)(()=>C.find(t=>t.id===e),[C,e]),Q=(0,B.useMemo)(()=>{if(Z)return Z.seasonId;let e=x.filter(e=>e.serverRegion.toLowerCase()===M.toLowerCase());if(e.length===0)return null;let t=Math.max(...e.map(e=>e.number));return e.find(e=>e.number===t)?.id||null},[M,x,Z]),$=async()=>{if(!(!Q||!e))try{let t=await fetch(ce(`/api/v1/seasons/${Q}/server_matchings/${e}/abyss_artifact_admins/`));if(t.ok){let e=await t.json();e.errorCode===`Success`&&ge(e.data.results)}}catch(e){console.error(`Failed to fetch admins`,e)}};(0,B.useEffect)(()=>{(async()=>{let e=xe.trim();if(!e){X([]);return}we(!0);try{let t=await y(`/users/search?name=${encodeURIComponent(e)}`);if(t.ok){let e=await t.json();e.errorCode===`Success`&&X(e.data.results)}}catch(e){console.error(`Failed to search users`,e)}finally{we(!1)}})()},[xe]);let Te=async()=>{if(!(!Q||!e||!_e))try{(await y(`/seasons/${Q}/server_matchings/${e}/abyss_artifact_admins/${_e}`,{method:`POST`})).ok&&(Y(!1),$())}catch(e){console.error(`Failed to add admin`,e)}},Ee=async t=>{if(!(!Q||!e))try{(await y(`/seasons/${Q}/server_matchings/${e}/abyss_artifact_admins/${t}`,{method:`DELETE`})).ok&&$()}catch(e){console.error(`Failed to delete admin`,e)}};(0,B.useEffect)(()=>{Q&&(Z||D(Q,e),k(Q,void 0,e).then(e=>{K(e)}),$())},[Q,e,Z,D,k]);let De=(0,B.useMemo)(()=>{let t={};return he.filter(t=>t.serverMatchingId===e).forEach(e=>{t[e.mapName]||(t[e.mapName]=[]),t[e.mapName].push(e)}),Object.keys(t).forEach(e=>{t[e].sort((e,t)=>new Date(t.recordTime).getTime()-new Date(e.recordTime).getTime())}),t},[he,e]),Oe=(0,B.useMemo)(()=>{let e={};return Object.keys(w).forEach(t=>{e[t]=[...w[t]].sort((e,t)=>e.order-t.order)}),e},[w]),ke=(e,t)=>{Z&&(fe(t),me(e),W(!0))},Ae=(e,t)=>{Z&&(fe(e),me(t?{...t,id:``}:null),W(!0))},je=async t=>{if(Q)try{(await y(`/seasons/${Q}/maps/${t.mapName}/artifacts/states/${t.id}/verify`,{method:`POST`})).ok&&K(await k(Q,void 0,e))}catch(e){console.error(`Failed to verify admin`,e)}},Me=async t=>{Q&&await I(Q,t.mapName,t.id,e)&&K(await k(Q,void 0,e))},Ne=R(`UI/Resource/Texture/Icon/UT_Marker_AbyssArtifact_Neutral.webp`),Pe=R(`UI/Resource/Texture/Icon/UT_Marker_AbyssArtifact_Light.webp`),Fe=R(`UI/Resource/Texture/Icon/UT_Marker_AbyssArtifact_Dark.webp`);return!Z&&!Q?(0,V.jsx)(`div`,{className:`p-8 text-center`,children:i(`common:ui.loading`)}):(0,V.jsxs)(`div`,{className:`min-h-full flex flex-col`,children:[(0,V.jsxs)(`div`,{className:`flex-1 flex flex-col items-center p-4`,children:[(0,V.jsxs)(`div`,{className:`w-full max-w-[1400px] flex flex-col gap-6`,children:[(0,V.jsxs)(`div`,{className:`flex items-center gap-4`,children:[(0,V.jsx)(m,{isIconOnly:!0,variant:`flat`,className:`bg-character-card border-1 border-crafting-border`,onClick:()=>t({to:`/leaderboard`}),children:(0,V.jsx)(A,{icon:a})}),(0,V.jsx)(`h1`,{className:`text-2xl font-bold`,children:Z?`${Z.server1.serverName} VS ${Z.server2.serverName}`:i(`common:leaderboard.artifactDetails`)})]}),(0,V.jsx)(E,{className:`bg-character-equipment shadow-none border-1 border-crafting-border`,children:(0,V.jsxs)(s,{className:`flex justify-between items-center px-6 py-3`,children:[(0,V.jsxs)(`div`,{className:`flex items-center gap-2`,children:[(0,V.jsx)(`span`,{className:`font-bold`,children:i(`common:leaderboard.artifactAdmins`)}),(0,V.jsxs)(`div`,{className:`flex flex-wrap gap-2`,children:[q.map(e=>(0,V.jsx)(H,{title:i(`common:ui.confirmDelete`),onConfirm:()=>Ee(e.user.id),children:(0,V.jsx)(c,{variant:`flat`,color:`primary`,onClose:g?()=>{}:void 0,children:e.user.name||e.user.email})},e.id)),q.length===0&&(0,V.jsx)(`span`,{className:`text-sm text-default-400`,children:i(`common:ui.noData`)})]})]}),g&&(0,V.jsx)(m,{size:`sm`,color:`primary`,variant:`flat`,startContent:(0,V.jsx)(A,{icon:f}),onClick:()=>Y(!0),children:i(`common:ui.add`)})]})}),n.map(e=>{let t=De[e]||[],n=Oe[e]||[];return(0,V.jsxs)(E,{className:`bg-character-equipment shadow-none border-1 border-crafting-border`,children:[(0,V.jsxs)(s,{className:`flex justify-between items-center px-6 py-4`,children:[(0,V.jsx)(`h2`,{className:`text-xl font-bold`,children:i(`maps:${e}.description`)}),d&&(0,V.jsx)(m,{size:`sm`,color:`default`,variant:`flat`,startContent:(0,V.jsx)(A,{icon:f}),onClick:()=>Ae(e),children:i(`common:leaderboard.artifactState.create`)})]}),(0,V.jsx)(j,{}),(0,V.jsx)(p,{className:`p-0 overflow-x-auto`,children:(0,V.jsxs)(re,{"aria-label":`Artifact states for ${e}`,className:`min-w-full`,removeWrapper:!0,classNames:{th:`bg-character-card text-foreground border-b border-crafting-border first:rounded-none last:rounded-none`,td:`py-3 px-4 border-b border-crafting-border/50`},children:[(0,V.jsx)(P,{columns:[{id:`recordTime`,label:i(`common:leaderboard.artifactState.recordTime`),width:200},...n.map(t=>({id:t.id,label:i(`markers/${e}:${t.markerId}.name`,{defaultValue:t.marker.name}),isArtifact:!0})),{id:`is_verified`,label:i(`common:leaderboard.artifactState.isVerified`),width:100},{id:`contributors`,label:i(`common:leaderboard.artifactState.contributors`),width:200},{id:`options`,label:i(`common:leaderboard.options`),width:100}],children:e=>(0,V.jsx)(_,{width:e.width,align:`center`,children:e.isArtifact?(0,V.jsx)(`div`,{className:`flex flex-col items-center gap-1 min-w-[120px]`,children:(0,V.jsx)(`span`,{className:`text-[12px] whitespace-nowrap overflow-hidden text-ellipsis max-w-[120px]`,children:e.label})}):e.label},e.id)}),(0,V.jsx)(h,{emptyContent:i(`common:ui.noData`),items:t.map(t=>({type:`data`,id:t.id,state:t,mapName:e,arts:n})),children:e=>(0,V.jsxs)(N,{children:[(0,V.jsx)(b,{children:(0,V.jsx)(`div`,{className:`flex flex-col`,children:(0,V.jsx)(`span`,{className:`font-medium`,children:new Date(e.state.recordTime).toLocaleString()})})},`recordTime`),e.arts.map(t=>{let n=e.state.states.find(e=>e.abyssArtifactId===t.id);return(0,V.jsx)(b,{children:(0,V.jsx)(`div`,{className:`flex justify-center`,children:(0,V.jsx)(`img`,{src:n?.state===1?Pe:n?.state===2?Fe:Ne,alt:`state`,className:`w-10 h-10`})})},t.id)}),(0,V.jsx)(b,{children:(0,V.jsx)(`div`,{className:`flex justify-center`,children:(0,V.jsx)(A,{icon:e.state.isVerified?u:O,className:e.state.isVerified?`text-success`:`text-default-400`})})},`is_verified`),(0,V.jsx)(b,{children:(0,V.jsx)(`div`,{className:`flex flex-col items-center gap-1`,children:e.state.contributors&&e.state.contributors.length>0?e.state.contributors.map(e=>(0,V.jsx)(`span`,{className:`text-xs text-primary bg-primary/10 px-2 py-0.5 rounded-full`,children:e.user.name},e.id)):(0,V.jsx)(`span`,{className:`text-xs text-default-400`,children:`-`})})},`contributors`),(0,V.jsx)(b,{children:(0,V.jsx)(`div`,{className:`flex justify-center gap-2`,children:(()=>{let t=e.state.contributors?.some(e=>e.userId===d?.id),n=q.some(e=>e.user.id===d?.id),r=g||n||t,a=g||n;return(0,V.jsxs)(V.Fragment,{children:[(g||n)&&!e.state.isVerified&&(0,V.jsx)(o,{content:i(`common:leaderboard.artifactState.verify`),children:(0,V.jsx)(m,{isIconOnly:!0,size:`sm`,variant:`light`,onClick:()=>je(e.state),children:(0,V.jsx)(A,{icon:u,className:`text-success`})})}),r&&(0,V.jsx)(o,{content:i(`common:ui.edit`),children:(0,V.jsx)(m,{isIconOnly:!0,size:`sm`,variant:`light`,onClick:()=>ke(e.state,e.mapName),children:(0,V.jsx)(A,{icon:F,className:`text-primary`})})}),a&&(0,V.jsx)(H,{title:i(`common:leaderboard.deleteConfirm`,`Are you sure you want to delete this record?`),onConfirm:()=>Me(e.state),children:(0,V.jsx)(m,{isIconOnly:!0,size:`sm`,variant:`light`,children:(0,V.jsx)(A,{icon:S,className:`text-danger`})})})]})})()})},`options`)]},e.id)})]})})]},e)})]}),Z&&G&&(0,V.jsx)(de,{isOpen:U,onOpenChange:t=>{W(t),t||k(Q,void 0,e).then(e=>{K(e)})},matching:Z,mapName:G,artifacts:Oe[G]||[],initialState:pe,seasonId:Q}),(0,V.jsx)(r,{isOpen:J,onOpenChange:Y,children:(0,V.jsx)(ee,{className:`bg-character-card`,children:e=>(0,V.jsxs)(V.Fragment,{children:[(0,V.jsx)(ne,{className:`flex flex-col gap-1`,children:i(`common:leaderboard.addArtifactAdmin`)}),(0,V.jsx)(te,{children:(0,V.jsx)(v,{autoFocus:!0,label:i(`common:auth.username`),placeholder:i(`common:ui.search`),variant:`bordered`,items:Se,isLoading:Ce,inputValue:ye,onInputChange:be,onSelectionChange:e=>ve(String(e)),children:e=>(0,V.jsx)(T,{textValue:e.name||e.email,children:(0,V.jsxs)(`div`,{className:`flex flex-col`,children:[(0,V.jsx)(`span`,{className:`text-sm font-medium`,children:e.name||`No Name`}),(0,V.jsx)(`span`,{className:`text-xs text-default-800`,children:e.email})]})},e.id)})}),(0,V.jsxs)(l,{children:[(0,V.jsx)(m,{color:`danger`,variant:`flat`,onPress:e,children:i(`common:ui.cancel`)}),(0,V.jsx)(m,{color:`primary`,onPress:Te,children:i(`common:ui.add`)})]})]})})})]}),(0,V.jsx)(ue,{})]})}export{U as component};