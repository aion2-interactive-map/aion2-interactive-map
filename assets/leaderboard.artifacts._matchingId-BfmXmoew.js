import{s as e}from"./rolldown-runtime-Cb2Vi1zU.js";import{a as t,n}from"./vendor-react-Pim_c09P.js";import{Bt as r,D as i,Ft as a,Ht as o,Jt as s,Kt as c,Mt as l,Nt as u,O as d,Pt as f,Qt as p,St as m,Ut as h,Vt as g,X as _,Yt as v,Z as y,Zt as b,_t as x,an as S,at as C,bt as w,ct as T,dt as E,in as D,it as O,jt as k,mt as A,nn as j,on as M,pt as N,qt as P,sn as F,vt as I,xt as L,yt as R,z}from"./vendor-ui-Dsps467L.js";import{l as B,o as V,p as H,s as U,t as W,x as G,y as K}from"./index-CKmMS_6_.js";import{t as q}from"./AdaptiveTooltip-DPnA5d1f.js";import{t as J}from"./Footer-CCwJnfG6.js";var Y=e(t(),1),X=e(n(),1),Z=({isOpen:e,onOpenChange:t,matching:n,mapName:r,initialState:i,seasonId:o})=>{let{t:s,i18n:d}=G(`common`),{createArtifactState:m,updateArtifactState:g,artifactsByMap:_}=V(),v=(0,Y.useMemo)(()=>(_[r]||[]).sort((e,t)=>e.order-t.order),[_,r]),[b,x]=(0,Y.useState)(S(M())),[C,w]=(0,Y.useState)(`48:00:00`),[O,j]=(0,Y.useState)({}),[P,I]=(0,Y.useState)(!1),[L,R]=(0,Y.useState)(S(M())),z=e=>{let t=new Date(e).getTime(),n=Date.now(),r=t+1728e5-n;if(r<=0)return`48:00:00`;let i=Math.floor(r/(1e3*60*60)),a=Math.floor(r%(1e3*60*60)/(1e3*60)),o=Math.floor(r%(1e3*60)/1e3);return`${String(i).padStart(2,`0`)}:${String(a).padStart(2,`0`)}:${String(o).padStart(2,`0`)}`};(0,Y.useEffect)(()=>{if(e)if(i)if(new Date(i.recordTime).getTime()+2880*60*1e3-Date.now()<=0||!i.id){x(S(M())),w(`48:00:00`),R(S(M())),I(!0);let e={};i.states?i.states.forEach(t=>{e[t.abyssArtifactId]=t.state}):v.forEach(t=>{e[t.id]=1}),j(e)}else{x(D(i.recordTime)),w(z(i.recordTime)),R(D(i.recordTime)),I(!1);let e={};i.states.forEach(t=>{e[t.abyssArtifactId]=t.state}),j(e)}else{x(S(M())),w(`48:00:00`),R(S(M())),I(!0);let e={};v.forEach(t=>{e[t.id]=1}),j(e)}},[e,i,v]);let B=(0,Y.useMemo)(()=>!i||!i.id?!1:new Date(i.recordTime).getTime()+2880*60*1e3-Date.now()>0,[i]),H=(0,Y.useMemo)(()=>{if(!P)return L;if(!b||!C)return null;try{let e=b.toDate(),[t,n,r]=C.split(`:`).map(Number),i=((t||0)*3600+(n||0)*60+(r||0))*1e3,a=e.getTime()+i-48*3600*1e3;return D(new Date(a).toISOString())}catch{return null}},[b,C,P,L]),U=(0,Y.useMemo)(()=>{if(!P)return L?new Date(L.toDate()).toISOString():``;if(!b||!C)return``;try{let e=b.toDate(),[t,n,r]=C.split(`:`).map(Number),i=((t||0)*3600+(n||0)*60+(r||0))*1e3,a=e.getTime()+i-48*3600*1e3;return new Date(a).toISOString()}catch{return``}},[b,C,P,L]),W=async()=>{let e=Object.entries(O).map(([e,t])=>({abyssArtifactId:e,state:t})),a=!1;a=B&&i?await g(o,r,i.id,{states:e,recordTime:U}):await m(o,r,{serverMatchingId:n.id,states:e,recordTime:U}),a&&t(!1)},K=(e,t)=>{j(n=>({...n,[e]:t}))},J=e=>(0,X.jsxs)(`div`,{className:`flex items-center justify-between gap-4`,children:[(0,X.jsx)(`span`,{className:`text-sm flex-1`,children:s(`markers/${e.marker.mapId}:${e.markerId}.name`,e.marker.name)}),(0,X.jsxs)(N,{size:`sm`,className:`w-[100px]`,selectedKeys:[String(O[e.id]||1)],onSelectionChange:t=>K(e.id,Number(Array.from(t)[0])),disallowEmptySelection:!0,classNames:Z,popoverProps:{radius:`none`},listboxProps:Q,children:[(0,X.jsx)(A,{textValue:s(`leaderboard.artifactState.light`),children:s(`leaderboard.artifactState.light`)},`1`),(0,X.jsx)(A,{textValue:s(`leaderboard.artifactState.dark`),children:s(`leaderboard.artifactState.dark`)},`2`)]})]},e.id),Z={inputWrapper:`!bg-character-card hover:!bg-character-card focus:!bg-character-card !transition-none border-crafting-border border-1 shadow-none rounded-sm group-data-[hover=true]:!bg-character-card group-data-[focus=true]:!bg-character-card group-data-[focus-visible=true]:!bg-character-card min-h-[36px]`,popoverContent:`rounded-none p-0`,segment:`text-foreground`,trigger:`!bg-character-card hover:!bg-character-card focus:!bg-character-card !transition-none border-crafting-border border-1 shadow-none rounded-sm group-data-[hover=true]:!bg-character-card group-data-[focus=true]:!bg-character-card group-data-[focus-visible=true]:!bg-character-card min-h-[36px]`,innerWrapper:`py-0`},Q={itemClasses:{base:`rounded-none`}};return(0,X.jsx)(k,{isOpen:e,onOpenChange:t,size:`xl`,classNames:{base:`bg-character-equipment`},children:(0,X.jsx)(f,{children:e=>(0,X.jsxs)(X.Fragment,{children:[(0,X.jsxs)(l,{children:[s(B?`leaderboard.artifactState.update`:`leaderboard.artifactState.create`),` - ${n.server1.serverName} VS ${n.server2.serverName}`]}),(0,X.jsxs)(a,{className:`gap-4`,children:[(0,X.jsx)(`div`,{className:`flex items-center gap-2 mb-2`,children:(0,X.jsx)(c,{isSelected:P,onValueChange:I,size:`sm`,children:s(`leaderboard.artifactState.countdownMode`)})}),(0,X.jsx)(F,{locale:d.language,children:P?(0,X.jsxs)(X.Fragment,{children:[(0,X.jsxs)(`div`,{className:`relative group/picker`,children:[(0,X.jsx)(E,{label:s(`leaderboard.artifactState.uploadTime`),hideTimeZone:!0,showMonthAndYearPickers:!0,value:b,onChange:e=>{e&&x(e)},classNames:Z,granularity:`second`}),(0,X.jsx)(q,{content:s(`common:leaderboard.resetToNow`,`重置到当前时间`),children:(0,X.jsx)(p,{size:`sm`,variant:`flat`,isIconOnly:!0,className:`absolute right-10 bottom-2 z-20 h-6 w-6 min-w-0 bg-transparent`,onClick:()=>{x(S(M()))},children:(0,X.jsx)(T,{icon:y,className:`text-[12px]`})})})]}),(0,X.jsx)(h,{label:s(`leaderboard.artifactState.countdown`),placeholder:`hh:mm:ss`,value:C,onChange:e=>w(e.target.value),classNames:Z})]}):(0,X.jsx)(E,{label:s(`leaderboard.artifactState.recordTime`),hideTimeZone:!0,showMonthAndYearPickers:!0,value:L,onChange:e=>{e&&R(e)},classNames:Z,granularity:`second`})}),P&&(0,X.jsx)(F,{locale:d.language,children:(0,X.jsx)(E,{label:s(`leaderboard.artifactState.recordTime`),hideTimeZone:!0,showMonthAndYearPickers:!0,value:H,isDisabled:!0,classNames:Z,granularity:`second`})}),(0,X.jsxs)(`div`,{className:`flex flex-col gap-2 mt-2`,children:[(0,X.jsx)(`p`,{className:`font-bold`,children:s(`maps:${r}.description`)}),v.map(J)]})]}),(0,X.jsxs)(u,{children:[(0,X.jsx)(p,{variant:`light`,onPress:e,children:s(`leaderboard.artifactState.cancel`)}),(0,X.jsx)(p,{color:`primary`,onPress:W,children:s(`leaderboard.artifactState.save`)})]})]})})})},Q=({children:e,title:t,onConfirm:n,confirmText:i,cancelText:a,color:s=`danger`})=>{let{t:c}=G(`common`),[l,u]=Y.useState(!1);return(0,X.jsxs)(r,{isOpen:l,onOpenChange:e=>u(e),placement:`top`,children:[(0,X.jsx)(g,{children:e}),(0,X.jsx)(o,{className:`p-4`,children:(0,X.jsxs)(`div`,{className:`flex flex-col gap-4`,children:[(0,X.jsx)(`div`,{className:`text-sm font-medium`,children:t}),(0,X.jsxs)(`div`,{className:`flex justify-center gap-2`,children:[(0,X.jsx)(p,{size:`sm`,variant:`flat`,onClick:()=>u(!1),children:a||c(`ui.cancel`)}),(0,X.jsx)(p,{size:`sm`,color:s,onClick:()=>{n(),u(!1)},children:i||c(`ui.confirm`)})]})]})})]})};function $(){let{matchingId:e}=W.useParams(),t=H(),n=[U.ABYSS_A,U.ABYSS_B],{t:r}=G([...n.map(e=>`markers/${e}`),`common`]),{user:a,isSuperUser:o}=B(),{seasons:c,serverMatchings:l,artifactsByMap:u,fetchServerMatching:f,fetchArtifactStates:h,region:g,deleteArtifactState:y}=V(),[S,E]=(0,Y.useState)(!1),[D,k]=(0,Y.useState)(null),[A,M]=(0,Y.useState)(null),[N,F]=(0,Y.useState)([]),q=(0,Y.useMemo)(()=>l.find(t=>t.id===e),[l,e]),$=(0,Y.useMemo)(()=>{if(q)return q.seasonId;let e=c.filter(e=>e.serverRegion.toLowerCase()===g.toLowerCase());if(e.length===0)return null;let t=Math.max(...e.map(e=>e.number));return e.find(e=>e.number===t)?.id||null},[g,c,q]);(0,Y.useEffect)(()=>{$&&(q||f($,e),h($,void 0,e).then(e=>{F(e)}))},[$,e,q,f,h]);let ee=(0,Y.useMemo)(()=>{let t={};return N.filter(t=>t.serverMatchingId===e).forEach(e=>{t[e.mapName]||(t[e.mapName]=[]),t[e.mapName].push(e)}),Object.keys(t).forEach(e=>{t[e].sort((e,t)=>new Date(t.recordTime).getTime()-new Date(e.recordTime).getTime())}),t},[N,e]),te=(0,Y.useMemo)(()=>{let e={};return Object.keys(u).forEach(t=>{e[t]=[...u[t]].sort((e,t)=>e.order-t.order)}),e},[u]),ne=(e,t)=>{q&&(k(t),M(e),E(!0))},re=(e,t)=>{q&&(k(e),M(t?{...t,id:``}:null),E(!0))},ie=async t=>{$&&await y($,t.mapName,t.id,e)&&F(await h($,void 0,e))},ae=(e,t)=>{let n=new Date(e).getTime(),i=new Date(t).getTime(),a=Math.abs(n-i)-2880*60*1e3,o=a<0,s=Math.abs(a),c=Math.floor(s/(1e3*60*60)),l=Math.floor(s%(1e3*60*60)/(1e3*60)),u=Math.floor(s%(1e3*60)/1e3),d=`${String(c).padStart(2,`0`)}:${String(l).padStart(2,`0`)}:${String(u).padStart(2,`0`)}`;return o?r(`common:leaderboard.refreshedAgo`,{time:d}):d},oe=K(`UI/Resource/Texture/Icon/UT_Marker_AbyssArtifact_Neutral.webp`),se=K(`UI/Resource/Texture/Icon/UT_Marker_AbyssArtifact_Light.webp`),ce=K(`UI/Resource/Texture/Icon/UT_Marker_AbyssArtifact_Dark.webp`);return!q&&!$?(0,X.jsx)(`div`,{className:`p-8 text-center`,children:r(`common:ui.loading`)}):(0,X.jsxs)(`div`,{className:`min-h-full flex flex-col`,children:[(0,X.jsxs)(`div`,{className:`flex-1 flex flex-col items-center p-4`,children:[(0,X.jsxs)(`div`,{className:`w-full max-w-[1400px] flex flex-col gap-6`,children:[(0,X.jsxs)(`div`,{className:`flex items-center gap-4`,children:[(0,X.jsx)(p,{isIconOnly:!0,variant:`flat`,className:`bg-character-card border-1 border-crafting-border`,onClick:()=>t({to:`/leaderboard`}),children:(0,X.jsx)(T,{icon:i})}),(0,X.jsx)(`h1`,{className:`text-2xl font-bold`,children:q?`${q.server1.serverName} VS ${q.server2.serverName}`:r(`common:leaderboard.artifactDetails`)})]}),n.map(e=>{let t=ee[e]||[],n=te[e]||[];return(0,X.jsxs)(s,{className:`bg-character-equipment shadow-none border-1 border-crafting-border`,children:[(0,X.jsxs)(v,{className:`flex justify-between items-center px-6 py-4`,children:[(0,X.jsx)(`h2`,{className:`text-xl font-bold`,children:r(`maps:${e}.description`)}),a&&(0,X.jsx)(p,{size:`sm`,color:`default`,variant:`flat`,startContent:(0,X.jsx)(T,{icon:_}),onClick:()=>re(e),children:r(`common:leaderboard.artifactState.create`)})]}),(0,X.jsx)(j,{}),(0,X.jsx)(b,{className:`p-0 overflow-x-auto`,children:(0,X.jsxs)(m,{"aria-label":`Artifact states for ${e}`,className:`min-w-full`,removeWrapper:!0,classNames:{th:`bg-character-card text-foreground border-b border-crafting-border first:rounded-none last:rounded-none`,td:`py-3 px-4 border-b border-crafting-border/50`},children:[(0,X.jsx)(w,{columns:[{id:`recordTime`,label:r(`common:leaderboard.artifactState.recordTime`),width:200},...n.map(t=>({id:t.id,label:r(`markers/${e}:${t.markerId}.name`,{defaultValue:t.marker.name}),isArtifact:!0})),{id:`is_verified`,label:r(`common:leaderboard.artifactState.isVerified`),width:100},{id:`contributors`,label:r(`common:leaderboard.artifactState.contributors`),width:200},{id:`options`,label:r(`common:leaderboard.options`),width:100}],children:e=>(0,X.jsx)(L,{width:e.width,align:`center`,children:e.isArtifact?(0,X.jsx)(`div`,{className:`flex flex-col items-center gap-1 min-w-[120px]`,children:(0,X.jsx)(`span`,{className:`text-[12px] whitespace-nowrap overflow-hidden text-ellipsis max-w-[120px]`,children:e.label})}):e.label},e.id)}),(0,X.jsx)(I,{emptyContent:r(`common:ui.noData`),items:t.flatMap((r,i)=>{let a=[];if(a.push({type:`data`,id:r.id,state:r,mapName:e,arts:n}),i<t.length-1){let e=t[i+1];a.push({type:`diff`,id:`diff-${r.id}-${e.id}`,state:r,nextState:e,arts:n})}return a}),children:e=>{if(e.type===`diff`){let t=ae(e.state.recordTime,e.nextState.recordTime);return(0,X.jsx)(R,{className:`bg-default-50/30`,children:(0,X.jsx)(x,{colSpan:n.length+4,children:(0,X.jsx)(`div`,{className:`flex justify-center items-center px-4 py-1`,children:(0,X.jsxs)(`span`,{className:`text-sm text-default-800 italic text-center`,children:[r(`common:leaderboard.timeDiffToNext`,`Time diff to next record`),`: `,t]})})})},e.id)}return(0,X.jsxs)(R,{children:[(0,X.jsx)(x,{children:(0,X.jsx)(`div`,{className:`flex flex-col`,children:(0,X.jsx)(`span`,{className:`font-medium`,children:new Date(e.state.recordTime).toLocaleString()})})},`recordTime`),e.arts.map(t=>{let n=e.state.states.find(e=>e.abyssArtifactId===t.id);return(0,X.jsx)(x,{children:(0,X.jsx)(`div`,{className:`flex justify-center`,children:(0,X.jsx)(`img`,{src:n?.state===1?se:n?.state===2?ce:oe,alt:`state`,className:`w-10 h-10`})})},t.id)}),(0,X.jsx)(x,{children:(0,X.jsx)(`div`,{className:`flex justify-center`,children:(0,X.jsx)(T,{icon:e.state.isVerified?d:O,className:e.state.isVerified?`text-success`:`text-default-400`})})},`is_verified`),(0,X.jsx)(x,{children:(0,X.jsx)(`div`,{className:`flex flex-col items-center gap-1`,children:e.state.contributors&&e.state.contributors.length>0?e.state.contributors.map(e=>(0,X.jsx)(`span`,{className:`text-xs text-primary bg-primary/10 px-2 py-0.5 rounded-full`,children:e.user.name},e.id)):(0,X.jsx)(`span`,{className:`text-xs text-default-400`,children:`-`})})},`contributors`),(0,X.jsx)(x,{children:(0,X.jsx)(`div`,{className:`flex justify-center gap-2`,children:(()=>{let t=e.state.contributors?.some(e=>e.userId===a?.id),n=o||t,i=o;return(0,X.jsxs)(X.Fragment,{children:[n&&(0,X.jsx)(P,{content:r(`common:ui.edit`),children:(0,X.jsx)(p,{isIconOnly:!0,size:`sm`,variant:`light`,onClick:()=>ne(e.state,e.mapName),children:(0,X.jsx)(T,{icon:z,className:`text-primary`})})}),i&&(0,X.jsx)(Q,{title:r(`common:leaderboard.deleteConfirm`,`Are you sure you want to delete this record?`),onConfirm:()=>ie(e.state),children:(0,X.jsx)(p,{isIconOnly:!0,size:`sm`,variant:`light`,children:(0,X.jsx)(T,{icon:C,className:`text-danger`})})})]})})()})},`options`)]},e.id)}})]})})]},e)})]}),q&&D&&(0,X.jsx)(Z,{isOpen:S,onOpenChange:t=>{E(t),t||h($,void 0,e).then(e=>{F(e)})},matching:q,mapName:D,artifacts:te[D]||[],initialState:A,seasonId:$})]}),(0,X.jsx)(J,{})]})}export{$ as component};