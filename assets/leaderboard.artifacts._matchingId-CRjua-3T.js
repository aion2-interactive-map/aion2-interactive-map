import{s as e}from"./rolldown-runtime-Cb2Vi1zU.js";import{a as t,n}from"./vendor-react-Pim_c09P.js";import{At as r,Bt as i,D as a,Gt as o,Kt as s,Mt as c,Nt as l,O as u,Rt as d,Wt as f,X as p,Xt as m,Yt as h,_t as g,an as _,bt as v,ct as y,dt as b,en as x,ft as S,gt as C,ht as w,in as T,jt as ee,kt as E,lt as D,nn as O,nt as k,on as A,ot as j,qt as M,rn as N,rt as P,ut as F,vt as te,yt as ne,z as re,zt as I}from"./vendor-ui-DdVhPiI0.js";import{S as L,b as R,l as ie,o as z,p as ae,s as oe,t as se,v as ce}from"./index-CXU6q_of.js";import{t as le}from"./useDebounce-CKxAnxa8.js";import{t as ue}from"./Footer-Bmvpf-EW.js";var B=e(t(),1),V=e(n(),1),de=({isOpen:e,onOpenChange:t,matching:n,mapName:i,initialState:a,seasonId:o})=>{let{t:s,i18n:u}=L(`common`),{createArtifactState:d,updateArtifactState:f,artifactsByMap:p}=z(),h=(0,B.useMemo)(()=>(p[i]||[]).sort((e,t)=>e.order-t.order),[p,i]),[g,v]=(0,B.useState)({}),[x,C]=(0,B.useState)(null),[w,k]=(0,B.useState)(null),j=(0,B.useCallback)(e=>{let t=new Date(Date.UTC(e.year,e.month-1,e.day,13,0,0)).getUTCDay();return t!==2&&t!==4&&t!==6},[]),M=(0,B.useCallback)(()=>{let e=T(_()),t=N(e);for(let e=0;e<7;e++){if(!j(t))return t;t=t.subtract({days:1})}return N(e)},[j]);(0,B.useEffect)(()=>{if(e)if(k(null),a)if(a.id){C(N(O(a.recordTime)));let e={};a.states.forEach(t=>{e[t.abyssArtifactId]=t.state}),v(e)}else{C(M());let e={};a.states?a.states.forEach(t=>{e[t.abyssArtifactId]=t.state}):h.forEach(t=>{e[t.id]=1}),v(e)}else{C(M());let e={};h.forEach(t=>{e[t.id]=1}),v(e)}},[e]);let P=(0,B.useMemo)(()=>!!(a&&a.id),[a]),F=(0,B.useMemo)(()=>x?new Date(Date.UTC(x.year,x.month-1,x.day,13,0,0)).toISOString():``,[x]),te=(0,B.useMemo)(()=>{let e=new Date;return e.setUTCHours(13,0,0,0),e.toLocaleTimeString(u.language,{hour:`2-digit`,minute:`2-digit`,hour12:!1})},[u.language]),ne=async()=>{let e=Object.entries(g).map(([e,t])=>({abyssArtifactId:e,state:t})),r=null;r=P&&a?await f(o,i,a.id,{states:e,recordTime:F}):await d(o,i,{serverMatchingId:n.id,states:e,recordTime:F}),r&&r.errorCode===`Success`?t(!1):r?r.errorCode===`ValidationError`?k(s(`leaderboard.artifactState.validationError`)):k(r.errorMessage||s(`errors.unknown`)):k(s(`errors.unknown`))},re=(e,t)=>{v(n=>({...n,[e]:t}))},I=e=>(0,V.jsxs)(`div`,{className:`flex items-center justify-between gap-4`,children:[(0,V.jsx)(`span`,{className:`text-sm flex-1`,children:s(`markers/${e.marker.mapId}:${e.markerId}.name`,e.marker.name)}),(0,V.jsxs)(b,{size:`sm`,className:`w-[100px]`,selectedKeys:[String(g[e.id]||1)],onSelectionChange:t=>{let n=Array.from(t)[0];n!==void 0&&re(e.id,Number(n))},disallowEmptySelection:!0,classNames:R,popoverProps:{radius:`none`},listboxProps:ie,children:[(0,V.jsx)(S,{textValue:s(`leaderboard.artifactState.light`),children:s(`leaderboard.artifactState.light`)},`1`),(0,V.jsx)(S,{textValue:s(`leaderboard.artifactState.dark`),children:s(`leaderboard.artifactState.dark`)},`2`)]})]},e.id),R={inputWrapper:`!bg-character-card hover:!bg-character-card focus:!bg-character-card !transition-none border-crafting-border border-1 shadow-none rounded-sm group-data-[hover=true]:!bg-character-card group-data-[focus=true]:!bg-character-card group-data-[focus-visible=true]:!bg-character-card min-h-[36px]`,popoverContent:`rounded-none p-0`,segment:`text-foreground`,trigger:`!bg-character-card hover:!bg-character-card focus:!bg-character-card !transition-none border-crafting-border border-1 shadow-none rounded-sm group-data-[hover=true]:!bg-character-card group-data-[focus=true]:!bg-character-card group-data-[focus-visible=true]:!bg-character-card min-h-[36px]`,innerWrapper:`py-0`},ie={itemClasses:{base:`rounded-none`}};return(0,V.jsx)(E,{isOpen:e,onOpenChange:t,size:`xl`,classNames:{base:`bg-character-equipment`},children:(0,V.jsx)(c,{children:e=>(0,V.jsxs)(V.Fragment,{children:[(0,V.jsxs)(r,{children:[s(P?`leaderboard.artifactState.update`:`leaderboard.artifactState.create`),` - ${n.server1.serverName} VS ${n.server2.serverName}`]}),(0,V.jsxs)(l,{className:`gap-4`,children:[w&&(0,V.jsx)(y,{color:`danger`,variant:`flat`,onClose:()=>k(null),children:w}),(0,V.jsx)(A,{locale:u.language,children:(0,V.jsx)(D,{label:s(`leaderboard.artifactState.recordTime`),hideTimeZone:!0,showMonthAndYearPickers:!0,value:x,onChange:e=>{e&&C(e)},isDateUnavailable:j,classNames:R,description:s(`leaderboard.artifactState.timeFixedNote`,{time:te})})}),(0,V.jsxs)(`div`,{className:`flex flex-col gap-2 mt-2`,children:[(0,V.jsx)(`p`,{className:`font-bold`,children:s(`maps:${i}.description`)}),h.map(I)]})]}),(0,V.jsxs)(ee,{children:[(0,V.jsx)(m,{variant:`light`,onPress:e,children:s(`leaderboard.artifactState.cancel`)}),(0,V.jsx)(m,{color:`primary`,onPress:ne,children:s(`leaderboard.artifactState.save`)})]})]})})})},H=({children:e,title:t,onConfirm:n,confirmText:r,cancelText:a,color:o=`danger`})=>{let{t:s}=L(`common`),[c,l]=B.useState(!1);return(0,V.jsxs)(d,{isOpen:c,onOpenChange:e=>l(e),placement:`top`,children:[(0,V.jsx)(I,{children:e}),(0,V.jsx)(i,{className:`p-4`,children:(0,V.jsxs)(`div`,{className:`flex flex-col gap-4`,children:[(0,V.jsx)(`div`,{className:`text-sm font-medium`,children:t}),(0,V.jsxs)(`div`,{className:`flex justify-center gap-2`,children:[(0,V.jsx)(m,{size:`sm`,variant:`flat`,onClick:()=>l(!1),children:a||s(`ui.cancel`)}),(0,V.jsx)(m,{size:`sm`,color:o,onClick:()=>{n(),l(!1)},children:r||s(`ui.confirm`)})]})]})})]})};function U(){let{matchingId:e}=se.useParams(),t=ae(),n=[oe.ABYSS_A,oe.ABYSS_B],{t:i}=L([...n.map(e=>`markers/${e}`),`common`]),{user:d,isSuperUser:_,fetchWithAuth:y}=ie(),{seasons:b,serverMatchings:T,artifactsByMap:D,fetchServerMatching:O,fetchArtifactStates:A,region:N,deleteArtifactState:I}=z(),[U,W]=(0,B.useState)(!1),[G,fe]=(0,B.useState)(null),[pe,me]=(0,B.useState)(null),[he,K]=(0,B.useState)([]),[q,ge]=(0,B.useState)([]),[J,Y]=(0,B.useState)(!1),[_e,ve]=(0,B.useState)(``),[ye,be]=(0,B.useState)(``),xe=le(ye,500),[Se,X]=(0,B.useState)([]),[Ce,we]=(0,B.useState)(!1);(0,B.useEffect)(()=>{J||(ve(``),be(``),X([]))},[J]);let Z=(0,B.useMemo)(()=>T.find(t=>t.id===e),[T,e]),Q=(0,B.useMemo)(()=>{if(Z)return Z.seasonId;let e=b.filter(e=>e.serverRegion.toLowerCase()===N.toLowerCase());if(e.length===0)return null;let t=Math.max(...e.map(e=>e.number));return e.find(e=>e.number===t)?.id||null},[N,b,Z]),$=async()=>{if(!(!Q||!e))try{let t=await fetch(ce(`/api/v1/seasons/${Q}/server_matchings/${e}/abyss_artifact_admins/`));if(t.ok){let e=await t.json();e.errorCode===`Success`&&ge(e.data.results)}}catch(e){console.error(`Failed to fetch admins`,e)}};(0,B.useEffect)(()=>{(async()=>{let e=xe.trim();if(!e){X([]);return}we(!0);try{let t=await y(`/users/search?name=${encodeURIComponent(e)}`);if(t.ok){let e=await t.json();e.errorCode===`Success`&&X(e.data.results)}}catch(e){console.error(`Failed to search users`,e)}finally{we(!1)}})()},[xe]);let Te=async()=>{if(!(!Q||!e||!_e))try{(await y(`/seasons/${Q}/server_matchings/${e}/abyss_artifact_admins/${_e}`,{method:`POST`})).ok&&(Y(!1),$())}catch(e){console.error(`Failed to add admin`,e)}},Ee=async t=>{if(!(!Q||!e))try{(await y(`/seasons/${Q}/server_matchings/${e}/abyss_artifact_admins/${t}`,{method:`DELETE`})).ok&&$()}catch(e){console.error(`Failed to delete admin`,e)}};(0,B.useEffect)(()=>{Q&&(Z||O(Q,e),A(Q,void 0,e).then(e=>{K(e)}),$())},[Q,e,Z,O,A]);let De=(0,B.useMemo)(()=>{let t={};return he.filter(t=>t.serverMatchingId===e).forEach(e=>{t[e.mapName]||(t[e.mapName]=[]),t[e.mapName].push(e)}),Object.keys(t).forEach(e=>{t[e].sort((e,t)=>new Date(t.recordTime).getTime()-new Date(e.recordTime).getTime())}),t},[he,e]),Oe=(0,B.useMemo)(()=>{let e={};return Object.keys(D).forEach(t=>{e[t]=[...D[t]].sort((e,t)=>e.order-t.order)}),e},[D]),ke=(e,t)=>{Z&&(fe(t),me(e),W(!0))},Ae=(e,t)=>{Z&&(fe(e),me(t?{...t,id:``}:null),W(!0))},je=async t=>{if(Q)try{(await y(`/seasons/${Q}/maps/${t.mapName}/artifacts/states/${t.id}/verify`,{method:`POST`})).ok&&K(await A(Q,void 0,e))}catch(e){console.error(`Failed to verify admin`,e)}},Me=async t=>{Q&&await I(Q,t.mapName,t.id,e)&&K(await A(Q,void 0,e))},Ne=R(`UI/Resource/Texture/Icon/UT_Marker_AbyssArtifact_Neutral.webp`),Pe=R(`UI/Resource/Texture/Icon/UT_Marker_AbyssArtifact_Light.webp`),Fe=R(`UI/Resource/Texture/Icon/UT_Marker_AbyssArtifact_Dark.webp`);return!Z&&!Q?(0,V.jsx)(`div`,{className:`p-8 text-center`,children:i(`common:ui.loading`)}):(0,V.jsxs)(`div`,{className:`min-h-full flex flex-col`,children:[(0,V.jsxs)(`div`,{className:`flex-1 flex flex-col items-center p-4`,children:[(0,V.jsxs)(`div`,{className:`w-full max-w-[1400px] flex flex-col gap-6`,children:[(0,V.jsxs)(`div`,{className:`flex items-center gap-4`,children:[(0,V.jsx)(m,{isIconOnly:!0,variant:`flat`,className:`bg-character-card border-1 border-crafting-border`,onClick:()=>t({to:`/leaderboard`}),children:(0,V.jsx)(j,{icon:a})}),(0,V.jsx)(`h1`,{className:`text-2xl font-bold`,children:Z?`${Z.server1.serverName} VS ${Z.server2.serverName}`:i(`common:leaderboard.artifactDetails`)})]}),(0,V.jsx)(s,{className:`bg-character-equipment shadow-none border-1 border-crafting-border`,children:(0,V.jsxs)(M,{className:`flex justify-between items-center px-6 py-3`,children:[(0,V.jsxs)(`div`,{className:`flex items-center gap-2`,children:[(0,V.jsx)(`span`,{className:`font-bold`,children:i(`common:leaderboard.artifactAdmins`)}),(0,V.jsxs)(`div`,{className:`flex flex-wrap gap-2`,children:[q.map(e=>(0,V.jsx)(H,{title:i(`common:ui.confirmDelete`),onConfirm:()=>Ee(e.user.id),children:(0,V.jsx)(o,{variant:`flat`,color:`primary`,onClose:_?()=>{}:void 0,children:e.user.name||e.user.email})},e.id)),q.length===0&&(0,V.jsx)(`span`,{className:`text-sm text-default-400`,children:i(`common:ui.noData`)})]})]}),_&&(0,V.jsx)(m,{size:`sm`,color:`primary`,variant:`flat`,startContent:(0,V.jsx)(j,{icon:p}),onClick:()=>Y(!0),children:i(`common:ui.add`)})]})}),n.map(e=>{let t=De[e]||[],n=Oe[e]||[];return(0,V.jsxs)(s,{className:`bg-character-equipment shadow-none border-1 border-crafting-border`,children:[(0,V.jsxs)(M,{className:`flex justify-between items-center px-6 py-4`,children:[(0,V.jsx)(`h2`,{className:`text-xl font-bold`,children:i(`maps:${e}.description`)}),d&&(0,V.jsx)(m,{size:`sm`,color:`default`,variant:`flat`,startContent:(0,V.jsx)(j,{icon:p}),onClick:()=>Ae(e),children:i(`common:leaderboard.artifactState.create`)})]}),(0,V.jsx)(x,{}),(0,V.jsx)(h,{className:`p-0 overflow-x-auto`,children:(0,V.jsxs)(v,{"aria-label":`Artifact states for ${e}`,className:`min-w-full`,removeWrapper:!0,classNames:{th:`bg-character-card text-foreground border-b border-crafting-border first:rounded-none last:rounded-none`,td:`py-3 px-4 border-b border-crafting-border/50`},children:[(0,V.jsx)(te,{columns:[{id:`recordTime`,label:i(`common:leaderboard.artifactState.recordTime`),width:200},...n.map(t=>({id:t.id,label:i(`markers/${e}:${t.markerId}.name`,{defaultValue:t.marker.name}),isArtifact:!0})),{id:`is_verified`,label:i(`common:leaderboard.artifactState.isVerified`),width:100},{id:`contributors`,label:i(`common:leaderboard.artifactState.contributors`),width:200},{id:`options`,label:i(`common:leaderboard.options`),width:100}],children:e=>(0,V.jsx)(ne,{width:e.width,align:`center`,children:e.isArtifact?(0,V.jsx)(`div`,{className:`flex flex-col items-center gap-1 min-w-[120px]`,children:(0,V.jsx)(`span`,{className:`text-[12px] whitespace-nowrap overflow-hidden text-ellipsis max-w-[120px]`,children:e.label})}):e.label},e.id)}),(0,V.jsx)(C,{emptyContent:i(`common:ui.noData`),items:t.map(t=>({type:`data`,id:t.id,state:t,mapName:e,arts:n})),children:e=>(0,V.jsxs)(g,{children:[(0,V.jsx)(w,{children:(0,V.jsx)(`div`,{className:`flex flex-col`,children:(0,V.jsx)(`span`,{className:`font-medium`,children:new Date(e.state.recordTime).toLocaleString()})})},`recordTime`),e.arts.map(t=>{let n=e.state.states.find(e=>e.abyssArtifactId===t.id);return(0,V.jsx)(w,{children:(0,V.jsx)(`div`,{className:`flex justify-center`,children:(0,V.jsx)(`img`,{src:n?.state===1?Pe:n?.state===2?Fe:Ne,alt:`state`,className:`w-10 h-10`})})},t.id)}),(0,V.jsx)(w,{children:(0,V.jsx)(`div`,{className:`flex justify-center`,children:(0,V.jsx)(j,{icon:e.state.isVerified?u:k,className:e.state.isVerified?`text-success`:`text-default-400`})})},`is_verified`),(0,V.jsx)(w,{children:(0,V.jsx)(`div`,{className:`flex flex-col items-center gap-1`,children:e.state.contributors&&e.state.contributors.length>0?e.state.contributors.map(e=>(0,V.jsx)(`span`,{className:`text-xs text-primary bg-primary/10 px-2 py-0.5 rounded-full`,children:e.user.name},e.id)):(0,V.jsx)(`span`,{className:`text-xs text-default-400`,children:`-`})})},`contributors`),(0,V.jsx)(w,{children:(0,V.jsx)(`div`,{className:`flex justify-center gap-2`,children:(()=>{let t=e.state.contributors?.some(e=>e.userId===d?.id),n=q.some(e=>e.user.id===d?.id),r=_||n||t,a=_||n;return(0,V.jsxs)(V.Fragment,{children:[(_||n)&&!e.state.isVerified&&(0,V.jsx)(f,{content:i(`common:leaderboard.artifactState.verify`),children:(0,V.jsx)(m,{isIconOnly:!0,size:`sm`,variant:`light`,onClick:()=>je(e.state),children:(0,V.jsx)(j,{icon:u,className:`text-success`})})}),r&&(0,V.jsx)(f,{content:i(`common:ui.edit`),children:(0,V.jsx)(m,{isIconOnly:!0,size:`sm`,variant:`light`,onClick:()=>ke(e.state,e.mapName),children:(0,V.jsx)(j,{icon:re,className:`text-primary`})})}),a&&(0,V.jsx)(H,{title:i(`common:leaderboard.deleteConfirm`,`Are you sure you want to delete this record?`),onConfirm:()=>Me(e.state),children:(0,V.jsx)(m,{isIconOnly:!0,size:`sm`,variant:`light`,children:(0,V.jsx)(j,{icon:P,className:`text-danger`})})})]})})()})},`options`)]},e.id)})]})})]},e)})]}),Z&&G&&(0,V.jsx)(de,{isOpen:U,onOpenChange:t=>{W(t),t||A(Q,void 0,e).then(e=>{K(e)})},matching:Z,mapName:G,artifacts:Oe[G]||[],initialState:pe,seasonId:Q}),(0,V.jsx)(E,{isOpen:J,onOpenChange:Y,children:(0,V.jsx)(c,{className:`bg-character-card`,children:e=>(0,V.jsxs)(V.Fragment,{children:[(0,V.jsx)(r,{className:`flex flex-col gap-1`,children:i(`common:leaderboard.addArtifactAdmin`)}),(0,V.jsx)(l,{children:(0,V.jsx)(F,{autoFocus:!0,label:i(`common:auth.username`),placeholder:i(`common:ui.search`),variant:`bordered`,items:Se,isLoading:Ce,inputValue:ye,onInputChange:be,onSelectionChange:e=>ve(String(e)),children:e=>(0,V.jsx)(S,{textValue:e.name||e.email,children:(0,V.jsxs)(`div`,{className:`flex flex-col`,children:[(0,V.jsx)(`span`,{className:`text-sm font-medium`,children:e.name||`No Name`}),(0,V.jsx)(`span`,{className:`text-xs text-default-800`,children:e.email})]})},e.id)})}),(0,V.jsxs)(ee,{children:[(0,V.jsx)(m,{color:`danger`,variant:`flat`,onPress:e,children:i(`common:ui.cancel`)}),(0,V.jsx)(m,{color:`primary`,onPress:Te,children:i(`common:ui.add`)})]})]})})})]}),(0,V.jsx)(ue,{})]})}export{U as component};