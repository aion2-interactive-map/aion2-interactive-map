import{s as e}from"./rolldown-runtime-Cb2Vi1zU.js";import{a as t,n}from"./vendor-react-Pim_c09P.js";import{Bt as r,D as i,Ft as a,Ht as o,Jt as s,Kt as c,Mt as l,Nt as u,O as d,Pt as ee,Qt as f,St as te,Vt as p,X as m,Yt as h,Zt as g,_t as _,an as v,at as y,bt as b,cn as x,ct as S,dt as C,ft as w,in as T,it as E,jt as ne,mt as D,nn as O,on as k,pt as A,qt as j,sn as M,ut as N,vt as P,xt as F,yt as re,z as ie}from"./vendor-ui-y3Fdaxop.js";import{S as I,b as L,l as ae,o as R,p as oe,s as se,t as ce,v as le}from"./index-CS2UYiuE.js";import{t as ue}from"./useDebounce-CKxAnxa8.js";import{t as de}from"./Footer-DayQ8meK.js";var z=e(t(),1),B=e(n(),1),fe=({isOpen:e,onOpenChange:t,matching:n,mapName:r,initialState:i,seasonId:o})=>{let{t:s,i18n:c}=I(`common`),{createArtifactState:d,updateArtifactState:te,artifactsByMap:p}=R(),m=(0,z.useMemo)(()=>(p[r]||[]).sort((e,t)=>e.order-t.order),[p,r]),[h,g]=(0,z.useState)({}),[_,y]=(0,z.useState)(null),[b,S]=(0,z.useState)(null),w=(0,z.useCallback)(e=>{let t=new Date(Date.UTC(e.year,e.month-1,e.day,13,0,0)).getUTCDay();return t!==2&&t!==4&&t!==6},[]),E=(0,z.useCallback)(()=>{let e=k(M()),t=v(e);for(let e=0;e<7;e++){if(!w(t))return t;t=t.subtract({days:1})}return v(e)},[w]);(0,z.useEffect)(()=>{if(e)if(S(null),i)if(i.id){y(v(T(i.recordTime)));let e={};i.states.forEach(t=>{e[t.abyssArtifactId]=t.state}),g(e)}else{y(E());let e={};i.states?i.states.forEach(t=>{e[t.abyssArtifactId]=t.state}):m.forEach(t=>{e[t.id]=1}),g(e)}else{y(E());let e={};m.forEach(t=>{e[t.id]=1}),g(e)}},[e]);let O=(0,z.useMemo)(()=>!!(i&&i.id),[i]),j=(0,z.useMemo)(()=>_?new Date(Date.UTC(_.year,_.month-1,_.day,13,0,0)).toISOString():``,[_]),P=(0,z.useMemo)(()=>{let e=new Date;return e.setUTCHours(13,0,0,0),e.toLocaleTimeString(c.language,{hour:`2-digit`,minute:`2-digit`,hour12:!1})},[c.language]),F=async()=>{let e=Object.entries(h).map(([e,t])=>({abyssArtifactId:e,state:t})),a=null;a=O&&i?await te(o,r,i.id,{states:e,recordTime:j}):await d(o,r,{serverMatchingId:n.id,states:e,recordTime:j}),a&&a.errorCode===`Success`?t(!1):a?a.errorCode===`ValidationError`?S(s(`leaderboard.artifactState.validationError`)):S(a.errorMessage||s(`errors.unknown`)):S(s(`errors.unknown`))},re=(e,t)=>{g(n=>({...n,[e]:t}))},ie=e=>(0,B.jsxs)(`div`,{className:`flex items-center justify-between gap-4`,children:[(0,B.jsx)(`span`,{className:`text-sm flex-1`,children:s(`markers/${e.marker.mapId}:${e.markerId}.name`,e.marker.name)}),(0,B.jsxs)(A,{size:`sm`,className:`w-[100px]`,selectedKeys:[String(h[e.id]||1)],onSelectionChange:t=>{let n=Array.from(t)[0];n!==void 0&&re(e.id,Number(n))},disallowEmptySelection:!0,classNames:L,popoverProps:{radius:`none`},listboxProps:ae,children:[(0,B.jsx)(D,{textValue:s(`leaderboard.artifactState.light`),children:s(`leaderboard.artifactState.light`)},`1`),(0,B.jsx)(D,{textValue:s(`leaderboard.artifactState.dark`),children:s(`leaderboard.artifactState.dark`)},`2`)]})]},e.id),L={inputWrapper:`!bg-character-card hover:!bg-character-card focus:!bg-character-card !transition-none border-crafting-border border-1 shadow-none rounded-sm group-data-[hover=true]:!bg-character-card group-data-[focus=true]:!bg-character-card group-data-[focus-visible=true]:!bg-character-card min-h-[36px]`,popoverContent:`rounded-none p-0`,segment:`text-foreground`,trigger:`!bg-character-card hover:!bg-character-card focus:!bg-character-card !transition-none border-crafting-border border-1 shadow-none rounded-sm group-data-[hover=true]:!bg-character-card group-data-[focus=true]:!bg-character-card group-data-[focus-visible=true]:!bg-character-card min-h-[36px]`,innerWrapper:`py-0`},ae={itemClasses:{base:`rounded-none`}};return(0,B.jsx)(ne,{isOpen:e,onOpenChange:t,size:`xl`,classNames:{base:`bg-character-equipment`},children:(0,B.jsx)(ee,{children:e=>(0,B.jsxs)(B.Fragment,{children:[(0,B.jsxs)(l,{children:[s(O?`leaderboard.artifactState.update`:`leaderboard.artifactState.create`),` - ${n.server1.serverName} VS ${n.server2.serverName}`]}),(0,B.jsxs)(a,{className:`gap-4`,children:[b&&(0,B.jsx)(N,{color:`danger`,variant:`flat`,onClose:()=>S(null),children:b}),(0,B.jsx)(x,{locale:c.language,children:(0,B.jsx)(C,{label:s(`leaderboard.artifactState.recordTime`),hideTimeZone:!0,showMonthAndYearPickers:!0,value:_,onChange:e=>{e&&y(e)},isDateUnavailable:w,classNames:L,description:s(`leaderboard.artifactState.timeFixedNote`,{time:P})})}),(0,B.jsxs)(`div`,{className:`flex flex-col gap-2 mt-2`,children:[(0,B.jsx)(`p`,{className:`font-bold`,children:s(`maps:${r}.description`)}),m.map(ie)]})]}),(0,B.jsxs)(u,{children:[(0,B.jsx)(f,{variant:`light`,onPress:e,children:s(`leaderboard.artifactState.cancel`)}),(0,B.jsx)(f,{color:`primary`,onPress:F,children:s(`leaderboard.artifactState.save`)})]})]})})})},V=({children:e,title:t,onConfirm:n,confirmText:i,cancelText:a,color:s=`danger`})=>{let{t:c}=I(`common`),[l,u]=z.useState(!1);return(0,B.jsxs)(r,{isOpen:l,onOpenChange:e=>u(e),placement:`top`,children:[(0,B.jsx)(p,{children:e}),(0,B.jsx)(o,{className:`p-4`,children:(0,B.jsxs)(`div`,{className:`flex flex-col gap-4`,children:[(0,B.jsx)(`div`,{className:`text-sm font-medium`,children:t}),(0,B.jsxs)(`div`,{className:`flex justify-center gap-2`,children:[(0,B.jsx)(f,{size:`sm`,variant:`flat`,onClick:()=>u(!1),children:a||c(`ui.cancel`)}),(0,B.jsx)(f,{size:`sm`,color:s,onClick:()=>{n(),u(!1)},children:i||c(`ui.confirm`)})]})]})})]})};function H(){let{matchingId:e}=ce.useParams(),t=oe(),n=[se.ABYSS_A,se.ABYSS_B],{t:r}=I([...n.map(e=>`markers/${e}`),`common`]),{user:o,isSuperUser:p,fetchWithAuth:v}=ae(),{seasons:x,serverMatchings:C,artifactsByMap:T,fetchServerMatching:k,fetchArtifactStates:A,region:M,deleteArtifactState:N}=R(),[H,U]=(0,z.useState)(!1),[W,pe]=(0,z.useState)(null),[me,he]=(0,z.useState)(null),[ge,G]=(0,z.useState)([]),[K,_e]=(0,z.useState)([]),[q,J]=(0,z.useState)(!1),[ve,ye]=(0,z.useState)(``),[be,xe]=(0,z.useState)(``),Se=ue(be,500),[Ce,Y]=(0,z.useState)([]),[we,Te]=(0,z.useState)(!1);(0,z.useEffect)(()=>{q||(ye(``),xe(``),Y([]))},[q]);let X=(0,z.useMemo)(()=>C.find(t=>t.id===e),[C,e]),Z=(0,z.useMemo)(()=>{if(X)return X.seasonId;let e=x.filter(e=>e.serverRegion.toLowerCase()===M.toLowerCase());if(e.length===0)return null;let t=Math.max(...e.map(e=>e.number));return e.find(e=>e.number===t)?.id||null},[M,x,X]),Q=async()=>{if(!(!Z||!e))try{let t=await fetch(le(`/api/v1/seasons/${Z}/server_matchings/${e}/abyss_artifact_admins/`));if(t.ok){let e=await t.json();e.errorCode===`Success`&&_e(e.data.results)}}catch(e){console.error(`Failed to fetch admins`,e)}};(0,z.useEffect)(()=>{(async()=>{let e=Se.trim();if(!e){Y([]);return}Te(!0);try{let t=await v(`/users/search?name=${encodeURIComponent(e)}`);if(t.ok){let e=await t.json();e.errorCode===`Success`&&Y(e.data.results)}}catch(e){console.error(`Failed to search users`,e)}finally{Te(!1)}})()},[Se]);let Ee=async()=>{if(!(!Z||!e||!ve))try{(await v(`/seasons/${Z}/server_matchings/${e}/abyss_artifact_admins/${ve}`,{method:`POST`})).ok&&(J(!1),Q())}catch(e){console.error(`Failed to add admin`,e)}},De=async t=>{if(!(!Z||!e))try{(await v(`/seasons/${Z}/server_matchings/${e}/abyss_artifact_admins/${t}`,{method:`DELETE`})).ok&&Q()}catch(e){console.error(`Failed to delete admin`,e)}};(0,z.useEffect)(()=>{Z&&(X||k(Z,e),A(Z,void 0,e).then(e=>{G(e)}),Q())},[Z,e,X,k,A]);let Oe=(0,z.useMemo)(()=>{let t={};return ge.filter(t=>t.serverMatchingId===e).forEach(e=>{t[e.mapName]||(t[e.mapName]=[]),t[e.mapName].push(e)}),Object.keys(t).forEach(e=>{t[e].sort((e,t)=>new Date(t.recordTime).getTime()-new Date(e.recordTime).getTime())}),t},[ge,e]),$=(0,z.useMemo)(()=>{let e={};return Object.keys(T).forEach(t=>{e[t]=[...T[t]].sort((e,t)=>e.order-t.order)}),e},[T]),ke=(e,t)=>{X&&(pe(t),he(e),U(!0))},Ae=(e,t)=>{X&&(pe(e),he(t?{...t,id:``}:null),U(!0))},je=async t=>{if(Z)try{(await v(`/seasons/${Z}/maps/${t.mapName}/artifacts/states/${t.id}/verify`,{method:`POST`})).ok&&G(await A(Z,void 0,e))}catch(e){console.error(`Failed to verify admin`,e)}},Me=async t=>{Z&&await N(Z,t.mapName,t.id,e)&&G(await A(Z,void 0,e))},Ne=L(`UI/Resource/Texture/Icon/UT_Marker_AbyssArtifact_Neutral.webp`),Pe=L(`UI/Resource/Texture/Icon/UT_Marker_AbyssArtifact_Light.webp`),Fe=L(`UI/Resource/Texture/Icon/UT_Marker_AbyssArtifact_Dark.webp`);return!X&&!Z?(0,B.jsx)(`div`,{className:`p-8 text-center`,children:r(`common:ui.loading`)}):(0,B.jsxs)(`div`,{className:`min-h-full flex flex-col`,children:[(0,B.jsxs)(`div`,{className:`flex-1 flex flex-col items-center p-4`,children:[(0,B.jsxs)(`div`,{className:`w-full max-w-[1400px] flex flex-col gap-6`,children:[(0,B.jsxs)(`div`,{className:`flex items-center gap-4`,children:[(0,B.jsx)(f,{isIconOnly:!0,variant:`flat`,className:`bg-character-card border-1 border-crafting-border`,onClick:()=>t({to:`/leaderboard`}),children:(0,B.jsx)(S,{icon:i})}),(0,B.jsx)(`h1`,{className:`text-2xl font-bold`,children:X?`${X.server1.serverName} VS ${X.server2.serverName}`:r(`common:leaderboard.artifactDetails`)})]}),(0,B.jsx)(s,{className:`bg-character-equipment shadow-none border-1 border-crafting-border`,children:(0,B.jsxs)(h,{className:`flex justify-between items-center px-6 py-3`,children:[(0,B.jsxs)(`div`,{className:`flex items-center gap-2`,children:[(0,B.jsx)(`span`,{className:`font-bold`,children:r(`common:leaderboard.artifactAdmins`)}),(0,B.jsxs)(`div`,{className:`flex flex-wrap gap-2`,children:[K.map(e=>(0,B.jsx)(V,{title:r(`common:ui.confirmDelete`),onConfirm:()=>De(e.user.id),children:(0,B.jsx)(j,{variant:`flat`,color:`primary`,onClose:p?()=>{}:void 0,children:e.user.name||e.user.email})},e.id)),K.length===0&&(0,B.jsx)(`span`,{className:`text-sm text-default-400`,children:r(`common:ui.noData`)})]})]}),p&&(0,B.jsx)(f,{size:`sm`,color:`primary`,variant:`flat`,startContent:(0,B.jsx)(S,{icon:m}),onClick:()=>J(!0),children:r(`common:ui.add`)})]})}),n.map(e=>{let t=Oe[e]||[],n=$[e]||[];return(0,B.jsxs)(s,{className:`bg-character-equipment shadow-none border-1 border-crafting-border`,children:[(0,B.jsxs)(h,{className:`flex justify-between items-center px-6 py-4`,children:[(0,B.jsx)(`h2`,{className:`text-xl font-bold`,children:r(`maps:${e}.description`)}),o&&(0,B.jsx)(f,{size:`sm`,color:`default`,variant:`flat`,startContent:(0,B.jsx)(S,{icon:m}),onClick:()=>Ae(e),children:r(`common:leaderboard.artifactState.create`)})]}),(0,B.jsx)(O,{}),(0,B.jsx)(g,{className:`p-0 overflow-x-auto`,children:(0,B.jsxs)(te,{"aria-label":`Artifact states for ${e}`,className:`min-w-full`,removeWrapper:!0,classNames:{th:`bg-character-card text-foreground border-b border-crafting-border first:rounded-none last:rounded-none`,td:`py-3 px-4 border-b border-crafting-border/50`},children:[(0,B.jsx)(b,{columns:[{id:`recordTime`,label:r(`common:leaderboard.artifactState.recordTime`),width:200},...n.map(t=>({id:t.id,label:r(`markers/${e}:${t.markerId}.name`,{defaultValue:t.marker.name}),isArtifact:!0})),{id:`is_verified`,label:r(`common:leaderboard.artifactState.isVerified`),width:100},{id:`contributors`,label:r(`common:leaderboard.artifactState.contributors`),width:200},{id:`options`,label:r(`common:leaderboard.options`),width:100}],children:e=>(0,B.jsx)(F,{width:e.width,align:`center`,children:e.isArtifact?(0,B.jsx)(`div`,{className:`flex flex-col items-center gap-1 min-w-[120px]`,children:(0,B.jsx)(`span`,{className:`text-[12px] whitespace-nowrap overflow-hidden text-ellipsis max-w-[120px]`,children:e.label})}):e.label},e.id)}),(0,B.jsx)(P,{emptyContent:r(`common:ui.noData`),items:t.map(t=>({type:`data`,id:t.id,state:t,mapName:e,arts:n})),children:e=>(0,B.jsxs)(re,{children:[(0,B.jsx)(_,{children:(0,B.jsx)(`div`,{className:`flex flex-col`,children:(0,B.jsx)(`span`,{className:`font-medium`,children:new Date(e.state.recordTime).toLocaleString()})})},`recordTime`),e.arts.map(t=>{let n=e.state.states.find(e=>e.abyssArtifactId===t.id);return(0,B.jsx)(_,{children:(0,B.jsx)(`div`,{className:`flex justify-center`,children:(0,B.jsx)(`img`,{src:n?.state===1?Pe:n?.state===2?Fe:Ne,alt:`state`,className:`w-10 h-10`})})},t.id)}),(0,B.jsx)(_,{children:(0,B.jsx)(`div`,{className:`flex justify-center`,children:(0,B.jsx)(S,{icon:e.state.isVerified?d:E,className:e.state.isVerified?`text-success`:`text-default-400`})})},`is_verified`),(0,B.jsx)(_,{children:(0,B.jsx)(`div`,{className:`flex flex-col items-center gap-1`,children:e.state.contributors&&e.state.contributors.length>0?e.state.contributors.map(e=>(0,B.jsx)(`span`,{className:`text-xs text-primary bg-primary/10 px-2 py-0.5 rounded-full`,children:e.user.name},e.id)):(0,B.jsx)(`span`,{className:`text-xs text-default-400`,children:`-`})})},`contributors`),(0,B.jsx)(_,{children:(0,B.jsx)(`div`,{className:`flex justify-center gap-2`,children:(()=>{let t=e.state.contributors?.some(e=>e.userId===o?.id),n=K.some(e=>e.user.id===o?.id),i=p||n||t,a=p||n;return(0,B.jsxs)(B.Fragment,{children:[(p||n)&&!e.state.isVerified&&(0,B.jsx)(c,{content:r(`common:leaderboard.artifactState.verify`),children:(0,B.jsx)(f,{isIconOnly:!0,size:`sm`,variant:`light`,onClick:()=>je(e.state),children:(0,B.jsx)(S,{icon:d,className:`text-success`})})}),i&&(0,B.jsx)(c,{content:r(`common:ui.edit`),children:(0,B.jsx)(f,{isIconOnly:!0,size:`sm`,variant:`light`,onClick:()=>ke(e.state,e.mapName),children:(0,B.jsx)(S,{icon:ie,className:`text-primary`})})}),a&&(0,B.jsx)(V,{title:r(`common:leaderboard.deleteConfirm`,`Are you sure you want to delete this record?`),onConfirm:()=>Me(e.state),children:(0,B.jsx)(f,{isIconOnly:!0,size:`sm`,variant:`light`,children:(0,B.jsx)(S,{icon:y,className:`text-danger`})})})]})})()})},`options`)]},e.id)})]})})]},e)})]}),X&&W&&(0,B.jsx)(fe,{isOpen:H,onOpenChange:t=>{U(t),t||A(Z,void 0,e).then(e=>{G(e)})},matching:X,mapName:W,artifacts:$[W]||[],initialState:me,seasonId:Z}),(0,B.jsx)(ne,{isOpen:q,onOpenChange:J,children:(0,B.jsx)(ee,{className:`bg-character-card`,children:e=>(0,B.jsxs)(B.Fragment,{children:[(0,B.jsx)(l,{className:`flex flex-col gap-1`,children:r(`common:leaderboard.addArtifactAdmin`)}),(0,B.jsx)(a,{children:(0,B.jsx)(w,{autoFocus:!0,label:r(`common:auth.username`),placeholder:r(`common:ui.search`),variant:`bordered`,items:Ce,isLoading:we,inputValue:be,onInputChange:xe,onSelectionChange:e=>ye(String(e)),children:e=>(0,B.jsx)(D,{textValue:e.name||e.email,children:(0,B.jsxs)(`div`,{className:`flex flex-col`,children:[(0,B.jsx)(`span`,{className:`text-sm font-medium`,children:e.name||`No Name`}),(0,B.jsx)(`span`,{className:`text-xs text-default-800`,children:e.email})]})},e.id)})}),(0,B.jsxs)(u,{children:[(0,B.jsx)(f,{color:`danger`,variant:`flat`,onPress:e,children:r(`common:ui.cancel`)}),(0,B.jsx)(f,{color:`primary`,onPress:Ee,children:r(`common:ui.add`)})]})]})})})]}),(0,B.jsx)(de,{})]})}export{H as component};