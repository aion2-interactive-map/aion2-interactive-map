import{s as e}from"./rolldown-runtime-Cb2Vi1zU.js";import{a as t,n}from"./vendor-react-Pim_c09P.js";import{$t as r,B as i,Ct as a,D as o,Ft as s,Ht as c,It as l,Jt as u,Mt as d,Nt as f,O as p,Pt as m,St as h,Ut as g,Vt as _,Xt as v,Yt as y,Z as b,Zt as x,at as S,bt as C,cn as w,dt as T,en as E,ft as D,ht as O,in as k,ln as A,lt as j,mt as M,on as N,ot as P,pt as F,sn as I,un as L,vt as R,xt as z,yt as B}from"./vendor-ui-OEpJDW5Y.js";import{S as V,b as H,h as U,l as W,o as G,p as K,s as q,t as J,v as ee}from"./index-BwyMTywJ.js";import{t as Y}from"./useDebounce-CKxAnxa8.js";import{t as te}from"./Footer-BMyClx4V.js";var X=e(t(),1),Z=e(n(),1),ne=({isOpen:e,onOpenChange:t,matching:n,mapName:r,initialState:i,seasonId:a})=>{let{t:o,i18n:c}=V(`common`),{createArtifactState:u,updateArtifactState:p,artifactsByMap:h}=G(),g=(0,X.useMemo)(()=>(h[r]||[]).sort((e,t)=>e.order-t.order),[h,r]),[_,v]=(0,X.useState)({}),[y,b]=(0,X.useState)(null),[x,S]=(0,X.useState)(null),C=(0,X.useCallback)(e=>{let t=new Date(Date.UTC(e.year,e.month-1,e.day,13,0,0)).getUTCDay();return t!==2&&t!==4&&t!==6},[]),k=(0,X.useCallback)(()=>{let e=w(A()),t=I(e);for(let e=0;e<7;e++){if(!C(t))return t;t=t.subtract({days:1})}return I(e)},[C]);(0,X.useEffect)(()=>{if(e)if(S(null),i)if(i.id){b(I(N(i.recordTime)));let e={};i.states.forEach(t=>{e[t.abyssArtifactId]=t.state}),v(e)}else{b(k());let e={};i.states?i.states.forEach(t=>{e[t.abyssArtifactId]=t.state}):g.forEach(t=>{e[t.id]=1}),v(e)}else{b(k());let e={};g.forEach(t=>{e[t.id]=1}),v(e)}},[e]);let j=(0,X.useMemo)(()=>!!(i&&i.id),[i]),P=(0,X.useMemo)(()=>y?new Date(Date.UTC(y.year,y.month-1,y.day,13,0,0)).toISOString():``,[y]),F=(0,X.useMemo)(()=>{let e=new Date;return e.setUTCHours(13,0,0,0),e.toLocaleTimeString(c.language,{hour:`2-digit`,minute:`2-digit`,hour12:!1})},[c.language]),R=async()=>{let e=Object.entries(_).map(([e,t])=>({abyssArtifactId:e,state:t})),s=null;s=j&&i?await p(a,r,i.id,{states:e,recordTime:P}):await u(a,r,{serverMatchingId:n.id,states:e,recordTime:P}),s&&s.errorCode===`Success`?t(!1):s?s.errorCode===`ValidationError`?S(o(`leaderboard.artifactState.validationError`)):S(s.errorMessage||o(`errors.unknown`)):S(o(`errors.unknown`))},z=(e,t)=>{v(n=>({...n,[e]:t}))},B=e=>(0,Z.jsxs)(`div`,{className:`flex items-center justify-between gap-4`,children:[(0,Z.jsx)(`span`,{className:`text-sm flex-1`,children:o(`markers/${e.marker.mapId}:${e.markerId}.name`,e.marker.name)}),(0,Z.jsxs)(M,{size:`sm`,className:`w-[100px]`,selectedKeys:[String(_[e.id]||1)],onSelectionChange:t=>{let n=Array.from(t)[0];n!==void 0&&z(e.id,Number(n))},disallowEmptySelection:!0,classNames:H,popoverProps:{radius:`none`},listboxProps:U,children:[(0,Z.jsx)(O,{textValue:o(`leaderboard.artifactState.light`),children:o(`leaderboard.artifactState.light`)},`1`),(0,Z.jsx)(O,{textValue:o(`leaderboard.artifactState.dark`),children:o(`leaderboard.artifactState.dark`)},`2`)]})]},e.id),H={inputWrapper:`!bg-character-card hover:!bg-character-card focus:!bg-character-card !transition-none border-crafting-border border-1 shadow-none rounded-sm group-data-[hover=true]:!bg-character-card group-data-[focus=true]:!bg-character-card group-data-[focus-visible=true]:!bg-character-card min-h-[36px]`,popoverContent:`rounded-none p-0`,segment:`text-foreground`,trigger:`!bg-character-card hover:!bg-character-card focus:!bg-character-card !transition-none border-crafting-border border-1 shadow-none rounded-sm group-data-[hover=true]:!bg-character-card group-data-[focus=true]:!bg-character-card group-data-[focus-visible=true]:!bg-character-card min-h-[36px]`,innerWrapper:`py-0`},U={itemClasses:{base:`rounded-none`}};return(0,Z.jsx)(d,{isOpen:e,onOpenChange:t,size:`xl`,classNames:{base:`bg-character-equipment`},children:(0,Z.jsx)(s,{children:e=>(0,Z.jsxs)(Z.Fragment,{children:[(0,Z.jsxs)(f,{children:[o(j?`leaderboard.artifactState.update`:`leaderboard.artifactState.create`),` - ${n.server1.serverName} VS ${n.server2.serverName}`]}),(0,Z.jsxs)(l,{className:`gap-4`,children:[x&&(0,Z.jsx)(T,{color:`danger`,variant:`flat`,onClose:()=>S(null),children:x}),(0,Z.jsx)(L,{locale:c.language,children:(0,Z.jsx)(D,{label:o(`leaderboard.artifactState.recordTime`),hideTimeZone:!0,showMonthAndYearPickers:!0,value:y,onChange:e=>{e&&b(e)},isDateUnavailable:C,classNames:H,description:o(`leaderboard.artifactState.timeFixedNote`,{time:F})})}),(0,Z.jsxs)(`div`,{className:`flex flex-col gap-2 mt-2`,children:[(0,Z.jsx)(`p`,{className:`font-bold`,children:o(`maps:${r}.description`)}),g.map(B)]})]}),(0,Z.jsxs)(m,{children:[(0,Z.jsx)(E,{variant:`light`,onPress:e,children:o(`leaderboard.artifactState.cancel`)}),(0,Z.jsx)(E,{color:`primary`,onPress:R,children:o(`leaderboard.artifactState.save`)})]})]})})})},Q=({children:e,title:t,onConfirm:n,confirmText:r,cancelText:i,color:a=`danger`})=>{let{t:o}=V(`common`),[s,l]=X.useState(!1);return(0,Z.jsxs)(_,{isOpen:s,onOpenChange:e=>l(e),placement:`top`,children:[(0,Z.jsx)(c,{children:e}),(0,Z.jsx)(g,{className:`p-4`,children:(0,Z.jsxs)(`div`,{className:`flex flex-col gap-4`,children:[(0,Z.jsx)(`div`,{className:`text-sm font-medium`,children:t}),(0,Z.jsxs)(`div`,{className:`flex justify-center gap-2`,children:[(0,Z.jsx)(E,{size:`sm`,variant:`flat`,onClick:()=>l(!1),children:i||o(`ui.cancel`)}),(0,Z.jsx)(E,{size:`sm`,color:a,onClick:()=>{n(),l(!1)},children:r||o(`ui.confirm`)})]})]})})]})},re=({admin:e,isSuperUser:t,onDelete:n,t:r})=>(0,Z.jsx)(Q,{title:r(`common:ui.confirmDelete`),onConfirm:()=>n(e.user.id),children:(0,Z.jsx)(y,{variant:`flat`,color:`primary`,onClose:t?()=>{}:void 0,children:e.user.name||e.user.email})}),ie=({isOpen:e,onOpenChange:t,onAddAdmin:n,fetchWithAuth:r,t:i})=>{let[a,o]=(0,X.useState)(``),[c,u]=(0,X.useState)(``),p=Y(c,500),[h,g]=(0,X.useState)([]),[_,v]=(0,X.useState)(!1);return(0,X.useEffect)(()=>{e||(o(``),u(``),g([]))},[e]),(0,X.useEffect)(()=>{(async()=>{let e=p.trim();if(!e){g([]);return}v(!0);try{let t=await r(`/users/search?name=${encodeURIComponent(e)}`);if(t.ok){let e=await t.json();e.errorCode===`Success`&&g(e.data.results)}}catch(e){console.error(`Failed to search users`,e)}finally{v(!1)}})()},[p,r]),(0,Z.jsx)(d,{isOpen:e,onOpenChange:t,children:(0,Z.jsx)(s,{className:`bg-character-card`,children:e=>(0,Z.jsxs)(Z.Fragment,{children:[(0,Z.jsx)(f,{className:`flex flex-col gap-1`,children:i(`common:leaderboard.addArtifactAdmin`)}),(0,Z.jsx)(l,{children:(0,Z.jsx)(F,{autoFocus:!0,label:i(`common:auth.username`),placeholder:i(`common:ui.search`),variant:`bordered`,items:h,isLoading:_,inputValue:c,onInputChange:u,onSelectionChange:e=>o(String(e)),children:e=>(0,Z.jsx)(O,{textValue:e.name||e.email,children:(0,Z.jsxs)(`div`,{className:`flex flex-col`,children:[(0,Z.jsx)(`span`,{className:`text-sm font-medium`,children:e.name||`No Name`}),(0,Z.jsx)(`span`,{className:`text-xs text-default-800`,children:e.email})]})},e.id)})}),(0,Z.jsxs)(m,{children:[(0,Z.jsx)(E,{color:`danger`,variant:`flat`,onPress:e,children:i(`common:ui.cancel`)}),(0,Z.jsx)(E,{color:`primary`,onPress:()=>n(a),children:i(`common:ui.add`)})]})]})})})},ae=({states:e,arts:t,mapName:n,admins:r,user:o,isSuperUser:s,onVerify:c,onEdit:l,onDelete:d,icons:f,t:m})=>(0,Z.jsxs)(a,{"aria-label":`Artifact states for ${n}`,className:`min-w-full`,removeWrapper:!0,classNames:{base:`bg-transparent`,table:`bg-transparent`,thead:`bg-transparent`,th:`bg-[#FFFFFF]/40 text-foreground border-b border-crafting-border first:rounded-none last:rounded-none text-[16px] backdrop-blur-sm`,td:`py-3 px-4 border-b border-crafting-border/50`,tr:`bg-character-equipment`},children:[(0,Z.jsx)(z,{columns:[{id:`recordTime`,label:m(`common:leaderboard.artifactState.recordTime`),width:200},...t.map(e=>({id:e.id,label:m(`markers/${n}:${e.markerId}.name`,{defaultValue:e.marker.name}),isArtifact:!0})),{id:`is_verified`,label:m(`common:leaderboard.artifactState.isVerified`),width:100},{id:`contributors`,label:m(`common:leaderboard.artifactState.contributors`),width:200},{id:`options`,label:m(`common:leaderboard.options`),width:100}],children:e=>(0,Z.jsx)(h,{width:e.width,align:`center`,children:e.isArtifact?(0,Z.jsx)(`div`,{className:`flex flex-col items-center gap-1 min-w-[160px]`,children:(0,Z.jsx)(`span`,{className:`text-base whitespace-nowrap overflow-hidden text-ellipsis max-w-[160px]`,children:e.label})}):e.label},e.id)}),(0,Z.jsx)(B,{emptyContent:m(`common:ui.noData`),items:e.map(e=>({type:`data`,id:e.id,state:e,mapName:n,arts:t})),children:e=>(0,Z.jsxs)(C,{children:[(0,Z.jsx)(R,{children:(0,Z.jsx)(`div`,{className:`flex flex-col`,children:(0,Z.jsx)(`span`,{className:`text-base text-default-800`,children:U(e.state.recordTime).format(`YYYY/M/D HH:mm:ss`)})})},`recordTime`),e.arts.map(t=>{let n=e.state.states.find(e=>e.abyssArtifactId===t.id);return(0,Z.jsx)(R,{children:(0,Z.jsx)(`div`,{className:`flex justify-center`,children:(0,Z.jsx)(`img`,{src:n?.state===1?f.light:n?.state===2?f.dark:f.neutral,alt:`state`,className:`w-10 h-10`})})},t.id)}),(0,Z.jsx)(R,{children:(0,Z.jsx)(`div`,{className:`flex justify-center`,children:(0,Z.jsx)(j,{icon:e.state.isVerified?p:S,className:e.state.isVerified?`text-success`:`text-default-400`})})},`is_verified`),(0,Z.jsx)(R,{children:(0,Z.jsx)(`div`,{className:`flex flex-col items-center gap-1`,children:e.state.contributors&&e.state.contributors.length>0?e.state.contributors.map(e=>(0,Z.jsx)(`span`,{className:`text-xs text-primary bg-primary/10 px-2 py-0.5 rounded-full`,children:e.user.name},e.id)):(0,Z.jsx)(`span`,{className:`text-xs text-default-400`,children:`-`})})},`contributors`),(0,Z.jsx)(R,{children:(0,Z.jsx)(`div`,{className:`flex justify-center gap-2`,children:(()=>{let t=e.state.contributors?.some(e=>e.userId===o?.id),n=r.some(e=>e.user.id===o?.id),a=s||n||t,f=s||n;return(0,Z.jsxs)(Z.Fragment,{children:[(s||n)&&!e.state.isVerified&&(0,Z.jsx)(u,{content:m(`common:leaderboard.artifactState.verify`),children:(0,Z.jsx)(E,{isIconOnly:!0,size:`sm`,variant:`light`,onClick:()=>c(e.state),children:(0,Z.jsx)(j,{icon:p,className:`text-success`})})}),a&&(0,Z.jsx)(u,{content:m(`common:ui.edit`),children:(0,Z.jsx)(E,{isIconOnly:!0,size:`sm`,variant:`light`,onClick:()=>l(e.state,e.mapName),children:(0,Z.jsx)(j,{icon:i,className:`text-primary`})})}),f&&(0,Z.jsx)(Q,{title:m(`common:leaderboard.deleteConfirm`,`Are you sure you want to delete this record?`),onConfirm:()=>d(e.state),children:(0,Z.jsx)(E,{isIconOnly:!0,size:`sm`,variant:`light`,children:(0,Z.jsx)(j,{icon:P,className:`text-danger`})})})]})})()})},`options`)]},e.id)})]}),oe=({matching:e,t})=>{let n=K();return(0,Z.jsxs)(`div`,{className:`flex items-center gap-4`,children:[(0,Z.jsx)(E,{isIconOnly:!0,variant:`flat`,className:`bg-character-card border-1 border-crafting-border`,onClick:()=>n({to:`/leaderboard`}),children:(0,Z.jsx)(j,{icon:o})}),(0,Z.jsx)(`h1`,{className:`text-2xl font-bold`,children:e?(0,Z.jsxs)(Z.Fragment,{children:[(0,Z.jsx)(`span`,{className:`text-primary`,children:e.server1.serverName}),(0,Z.jsx)(`span`,{className:`mx-2`,children:`VS`}),(0,Z.jsx)(`span`,{className:`text-secondary`,children:e.server2.serverName})]}):t(`common:leaderboard.artifactDetails`)})]})};function $(){let{matchingId:e}=J.useParams(),t=[q.ABYSS_A,q.ABYSS_B],{t:n}=V([...t.map(e=>`markers/${e}`),`common`]),{user:i,isSuperUser:a,fetchWithAuth:o}=W(),{seasons:s,serverMatchings:c,artifactsByMap:l,fetchServerMatching:u,fetchArtifactStates:d,region:f,deleteArtifactState:p}=G(),[m,h]=(0,X.useState)(!1),[g,_]=(0,X.useState)(null),[y,S]=(0,X.useState)(null),[C,w]=(0,X.useState)([]),[T,D]=(0,X.useState)([]),[O,A]=(0,X.useState)(!1),M=(0,X.useMemo)(()=>c.find(t=>t.id===e),[c,e]),N=(0,X.useMemo)(()=>{if(M)return M.seasonId;let e=s.filter(e=>e.serverRegion.toLowerCase()===f.toLowerCase());if(e.length===0)return null;let t=Math.max(...e.map(e=>e.number));return e.find(e=>e.number===t)?.id||null},[f,s,M]),P=async()=>{if(!(!N||!e))try{let t=await fetch(ee(`/api/v1/seasons/${N}/server_matchings/${e}/abyss_artifact_admins/`));if(t.ok){let e=await t.json();e.errorCode===`Success`&&D(e.data.results)}}catch(e){console.error(`Failed to fetch admins`,e)}},F=async t=>{if(!(!N||!e||!t))try{(await o(`/seasons/${N}/server_matchings/${e}/abyss_artifact_admins/${t}`,{method:`POST`})).ok&&(A(!1),P())}catch(e){console.error(`Failed to add admin`,e)}},I=async t=>{if(!(!N||!e))try{(await o(`/seasons/${N}/server_matchings/${e}/abyss_artifact_admins/${t}`,{method:`DELETE`})).ok&&P()}catch(e){console.error(`Failed to delete admin`,e)}};(0,X.useEffect)(()=>{N&&(M||u(N,e),d(N,void 0,e).then(e=>{w(e)}),P())},[N,e,M,u,d]);let L=(0,X.useMemo)(()=>{let t={};return C.filter(t=>t.serverMatchingId===e).forEach(e=>{t[e.mapName]||(t[e.mapName]=[]),t[e.mapName].push(e)}),Object.keys(t).forEach(e=>{t[e].sort((e,t)=>new Date(t.recordTime).getTime()-new Date(e.recordTime).getTime())}),t},[C,e]),R=(0,X.useMemo)(()=>{let e={};return Object.keys(l).forEach(t=>{e[t]=[...l[t]].sort((e,t)=>e.order-t.order)}),e},[l]),z=(e,t)=>{M&&(_(t),S(e),h(!0))},B=(e,t)=>{M&&(_(e),S(t?{...t,id:``}:null),h(!0))},U=async t=>{if(N)try{(await o(`/seasons/${N}/maps/${t.mapName}/artifacts/states/${t.id}/verify`,{method:`POST`})).ok&&w(await d(N,void 0,e))}catch(e){console.error(`Failed to verify admin`,e)}},K=async t=>{N&&await p(N,t.mapName,t.id,e)&&w(await d(N,void 0,e))},Y=H(`UI/Resource/Texture/Icon/UT_Marker_AbyssArtifact_Neutral.webp`),Q=H(`UI/Resource/Texture/Icon/UT_Marker_AbyssArtifact_Light.webp`),$=H(`UI/Resource/Texture/Icon/UT_Marker_AbyssArtifact_Dark.webp`);return!M&&!N?(0,Z.jsx)(`div`,{className:`p-8 text-center`,children:n(`common:ui.loading`)}):(0,Z.jsxs)(`div`,{className:`min-h-full flex flex-col`,children:[(0,Z.jsxs)(`div`,{className:`flex-1 flex flex-col items-center p-4`,children:[(0,Z.jsxs)(`div`,{className:`w-full max-w-[1400px] flex flex-col gap-6`,children:[(0,Z.jsx)(oe,{matching:M,t:n}),(0,Z.jsx)(v,{className:`bg-transparent shadow-none border-1 border-crafting-border backdrop-blur-sm`,children:(0,Z.jsxs)(x,{className:`flex justify-between items-center px-6 py-3`,children:[(0,Z.jsxs)(`div`,{className:`flex items-center gap-2`,children:[(0,Z.jsx)(`span`,{className:`font-bold`,children:n(`common:leaderboard.artifactAdmins`)}),(0,Z.jsxs)(`div`,{className:`flex flex-wrap gap-2`,children:[T.map(e=>(0,Z.jsx)(re,{admin:e,isSuperUser:a,onDelete:I,t:n},e.id)),T.length===0&&(0,Z.jsx)(`span`,{className:`text-sm text-default-400`,children:n(`common:ui.noData`)})]})]}),a&&(0,Z.jsx)(E,{size:`sm`,color:`primary`,variant:`flat`,startContent:(0,Z.jsx)(j,{icon:b}),onClick:()=>A(!0),children:n(`common:ui.add`)})]})}),t.map(e=>{let t=L[e]||[],o=R[e]||[];return(0,Z.jsxs)(v,{className:`bg-transparent shadow-none border-1 border-crafting-border backdrop-blur-sm`,children:[(0,Z.jsxs)(x,{className:`flex justify-between items-center px-6 py-4 bg-character-equipment`,children:[(0,Z.jsx)(`h2`,{className:`text-xl font-bold`,children:n(`maps:${e}.description`)}),i&&(0,Z.jsx)(E,{size:`sm`,color:`default`,variant:`flat`,startContent:(0,Z.jsx)(j,{icon:b}),onClick:()=>B(e),children:n(`common:leaderboard.artifactState.create`)})]}),(0,Z.jsx)(k,{}),(0,Z.jsx)(r,{className:`p-0 overflow-x-auto`,children:(0,Z.jsx)(ae,{states:t,arts:o,mapName:e,admins:T,user:i,isSuperUser:a,onVerify:U,onEdit:z,onDelete:K,icons:{neutral:Y,light:Q,dark:$},t:n})})]},e)})]}),M&&g&&(0,Z.jsx)(ne,{isOpen:m,onOpenChange:t=>{h(t),t||d(N,void 0,e).then(e=>{w(e)})},matching:M,mapName:g,artifacts:R[g]||[],initialState:y,seasonId:N}),(0,Z.jsx)(ie,{isOpen:O,onOpenChange:A,onAddAdmin:F,fetchWithAuth:o,t:n})]}),(0,Z.jsx)(te,{})]})}export{$ as component};