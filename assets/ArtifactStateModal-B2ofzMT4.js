import{s as e}from"./rolldown-runtime-Cb2Vi1zU.js";import{a as t,n}from"./vendor-react-Pim_c09P.js";import{At as r,Bt as i,Mt as a,Ot as o,Ut as s,Yt as c,Z as l,at as u,ct as d,dt as f,in as p,jt as m,kt as h,nn as g,rn as _,tn as v,ut as y}from"./vendor-ui-6zHdCyVc.js";import{o as b,x}from"./index-qKAaY4mI.js";import{t as S}from"./AdaptiveTooltip-DvuVJDhp.js";var C=e(t(),1),w=e(n(),1),T=({isOpen:e,onOpenChange:t,matching:n,mapName:T,initialState:E,seasonId:D})=>{let{t:O,i18n:k}=x(`common`),{createArtifactState:A,updateArtifactState:j,artifactsByMap:M}=b(),N=(0,C.useMemo)(()=>(M[T]||[]).sort((e,t)=>e.order-t.order),[M,T]),[P,F]=(0,C.useState)(g(_())),[I,L]=(0,C.useState)(`48:00:00`),[R,z]=(0,C.useState)({}),[B,V]=(0,C.useState)(!1),[H,U]=(0,C.useState)(g(_())),W=e=>{let t=new Date(e).getTime(),n=Date.now(),r=t+1728e5-n;if(r<=0)return`48:00:00`;let i=Math.floor(r/(1e3*60*60)),a=Math.floor(r%(1e3*60*60)/(1e3*60)),o=Math.floor(r%(1e3*60)/1e3);return`${String(i).padStart(2,`0`)}:${String(a).padStart(2,`0`)}:${String(o).padStart(2,`0`)}`};(0,C.useEffect)(()=>{if(e)if(E)if(new Date(E.recordTime).getTime()+2880*60*1e3-Date.now()<=0||!E.id){F(g(_())),L(`48:00:00`),U(g(_())),V(!0);let e={};E.states?E.states.forEach(t=>{e[t.abyssArtifactId]=t.state}):N.forEach(t=>{e[t.id]=1}),z(e)}else{F(v(E.recordTime)),L(W(E.recordTime)),U(v(E.recordTime)),V(!1);let e={};E.states.forEach(t=>{e[t.abyssArtifactId]=t.state}),z(e)}else{F(g(_())),L(`48:00:00`),U(g(_())),V(!0);let e={};N.forEach(t=>{e[t.id]=1}),z(e)}},[e,E,N]);let G=(0,C.useMemo)(()=>!E||!E.id?!1:new Date(E.recordTime).getTime()+2880*60*1e3-Date.now()>0,[E]),K=(0,C.useMemo)(()=>{if(!B)return H;if(!P||!I)return null;try{let e=P.toDate(),[t,n,r]=I.split(`:`).map(Number),i=((t||0)*3600+(n||0)*60+(r||0))*1e3,a=e.getTime()+i-48*3600*1e3;return v(new Date(a).toISOString())}catch{return null}},[P,I,B,H]),q=(0,C.useMemo)(()=>{if(!B)return H?new Date(H.toDate()).toISOString():``;if(!P||!I)return``;try{let e=P.toDate(),[t,n,r]=I.split(`:`).map(Number),i=((t||0)*3600+(n||0)*60+(r||0))*1e3,a=e.getTime()+i-48*3600*1e3;return new Date(a).toISOString()}catch{return``}},[P,I,B,H]),J=async()=>{let e=Object.entries(R).map(([e,t])=>({abyssArtifactId:e,state:t})),r=!1;r=G&&E?await j(D,T,E.id,{states:e,recordTime:q}):await A(D,T,{serverMatchingId:n.id,states:e,recordTime:q}),r&&t(!1)},Y=(e,t)=>{z(n=>({...n,[e]:t}))},X=e=>(0,w.jsxs)(`div`,{className:`flex items-center justify-between gap-4`,children:[(0,w.jsx)(`span`,{className:`text-sm flex-1`,children:O(`markers/${e.marker.mapId}:${e.markerId}.name`,e.marker.name)}),(0,w.jsxs)(y,{size:`sm`,className:`w-[100px]`,selectedKeys:[String(R[e.id]||1)],onSelectionChange:t=>Y(e.id,Number(Array.from(t)[0])),disallowEmptySelection:!0,classNames:Z,popoverProps:{radius:`none`},listboxProps:Q,children:[(0,w.jsx)(f,{textValue:O(`leaderboard.artifactState.light`),children:O(`leaderboard.artifactState.light`)},`1`),(0,w.jsx)(f,{textValue:O(`leaderboard.artifactState.dark`),children:O(`leaderboard.artifactState.dark`)},`2`)]})]},e.id),Z={inputWrapper:`!bg-character-card hover:!bg-character-card focus:!bg-character-card !transition-none border-crafting-border border-1 shadow-none rounded-sm group-data-[hover=true]:!bg-character-card group-data-[focus=true]:!bg-character-card group-data-[focus-visible=true]:!bg-character-card min-h-[36px]`,popoverContent:`rounded-none p-0`,segment:`text-foreground`,trigger:`!bg-character-card hover:!bg-character-card focus:!bg-character-card !transition-none border-crafting-border border-1 shadow-none rounded-sm group-data-[hover=true]:!bg-character-card group-data-[focus=true]:!bg-character-card group-data-[focus-visible=true]:!bg-character-card min-h-[36px]`,innerWrapper:`py-0`},Q={itemClasses:{base:`rounded-none`}};return(0,w.jsx)(o,{isOpen:e,onOpenChange:t,size:`xl`,classNames:{base:`bg-character-equipment`},children:(0,w.jsx)(m,{children:e=>(0,w.jsxs)(w.Fragment,{children:[(0,w.jsxs)(h,{children:[O(G?`leaderboard.artifactState.update`:`leaderboard.artifactState.create`),` - ${n.server1.serverName} VS ${n.server2.serverName}`]}),(0,w.jsxs)(a,{className:`gap-4`,children:[(0,w.jsx)(`div`,{className:`flex items-center gap-2 mb-2`,children:(0,w.jsx)(s,{isSelected:B,onValueChange:V,size:`sm`,children:O(`leaderboard.artifactState.countdownMode`)})}),(0,w.jsx)(p,{locale:k.language,children:B?(0,w.jsxs)(w.Fragment,{children:[(0,w.jsxs)(`div`,{className:`relative group/picker`,children:[(0,w.jsx)(d,{label:O(`leaderboard.artifactState.uploadTime`),hideTimeZone:!0,showMonthAndYearPickers:!0,value:P,onChange:e=>{e&&F(e)},classNames:Z,granularity:`second`}),(0,w.jsx)(S,{content:O(`common:leaderboard.resetToNow`,`重置到当前时间`),children:(0,w.jsx)(c,{size:`sm`,variant:`flat`,isIconOnly:!0,className:`absolute right-10 bottom-2 z-20 h-6 w-6 min-w-0 bg-transparent`,onClick:()=>{F(g(_()))},children:(0,w.jsx)(u,{icon:l,className:`text-[12px]`})})})]}),(0,w.jsx)(i,{label:O(`leaderboard.artifactState.countdown`),placeholder:`hh:mm:ss`,value:I,onChange:e=>L(e.target.value),classNames:Z})]}):(0,w.jsx)(d,{label:O(`leaderboard.artifactState.recordTime`),hideTimeZone:!0,showMonthAndYearPickers:!0,value:H,onChange:e=>{e&&U(e)},classNames:Z,granularity:`second`})}),B&&(0,w.jsx)(p,{locale:k.language,children:(0,w.jsx)(d,{label:O(`leaderboard.artifactState.recordTime`),hideTimeZone:!0,showMonthAndYearPickers:!0,value:K,isDisabled:!0,classNames:Z,granularity:`second`})}),(0,w.jsxs)(`div`,{className:`flex flex-col gap-2 mt-2`,children:[(0,w.jsx)(`p`,{className:`font-bold`,children:O(`maps:${T}.description`)}),N.map(X)]})]}),(0,w.jsxs)(r,{children:[(0,w.jsx)(c,{variant:`light`,onPress:e,children:O(`leaderboard.artifactState.cancel`)}),(0,w.jsx)(c,{color:`primary`,onPress:J,children:O(`leaderboard.artifactState.save`)})]})]})})})};export{T as t};